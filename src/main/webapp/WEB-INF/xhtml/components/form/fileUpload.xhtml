<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:a="http://richfaces.org/a4j"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:rich="http://richfaces.org/rich"
  xmlns:s="http://jboss.org/schema/seam/taglib"
  xmlns:wi="http://www.itx.com.br/jsf">
  <ui:param
    name="template"
    value="#{wi:get(template, '/WEB-INF/xhtml/components/templates/edit.xhtml')}" />
  <ui:param name="readonly" value="#{empty readonly ? true : props.readonly or not empty taskInstanceHome.variaveisDocumento[id].documentoBin.assinaturas}" />
<f:subview id="#{f.id}SubView">
    <s:div id="#{f.id}TipoDocDiv" styleClass="padding-top-10">
      <wi:selectOneMenuEntity
        id="#{f.id}tipoProcessoDocumento"
        label="#{infoxMessages['processoDocumento.classificacaoDocumento']}"
        value="#{taskInstanceHome.variaveisDocumento[id].classificacaoDocumento}"
        items="#{classificacaoDocumentoFacade.getUseableClassificacaoDocumento(false, taskInstanceHome.getVariableName(id), processoEpaHome.instance.naturezaCategoriaFluxo.fluxo.idFluxo)}"
        required="true"
        showLabelSelecione="true"
        rendered="#{not readonly}">
        <a:ajax
         render="#{f.id}TipoDocDiv #{f.id}Decoration #{f.id}ToolTipDivExterna #{f.id}documentoExistente assinaturaDocumentoDiv#{f.id}"
         event="change"
         execute="@this"
         listener="#{taskInstanceHome.removerDocumento(f.id)}"
         limitRender="true" />
      </wi:selectOneMenuEntity>
    </s:div>
    <s:div id="#{f.id}ToolTipDivExterna">
	    <s:div id="#{f.id}ToolTipDiv" styleClass="tooltip-parent" style="width: 10px" 
	    	rendered="#{not empty taskInstanceHome.variaveisDocumento[id].classificacaoDocumento and not readonly}">
			<h:graphicImage id="#{id}helpEditTipImg" url="#{wiSkin.imageFolder}/help.gif" />
			<div class="epp-tooltip">
				<div class="tooltip-panel">
					<s:div rendered="#{empty taskInstanceHome.variaveisDocumento[id].classificacaoDocumento}">
						<h:outputText value="Selecione uma classificação de documento" />
					</s:div>
					<s:div rendered="#{not empty taskInstanceHome.variaveisDocumento[id].classificacaoDocumento}">
						<div><h:outputText value="Extensões Aceitas:"/></div>
						<ui:repeat var="documento" value="#{taskInstanceHome.variaveisDocumento[id].classificacaoDocumento.acceptedTypesList}">
							<div><h:outputText value="#{documento}" styleClass="tooltip-panel-div"/></div>
						</ui:repeat>
						<s:div styleClass="tooltip-panel-top" rendered="#{not empty taskInstanceHome.variaveisDocumento[id].classificacaoDocumento.observacao}">
							<div>
								<h:outputText value="Observação:"/>
							</div>
							<h:outputText value="#{taskInstanceHome.variaveisDocumento[id].classificacaoDocumento.observacao}" />
						</s:div>
					</s:div>
				</div>
			</div>
		</s:div>
	</s:div>
    <s:decorate
    id="#{id}Decoration"
    template="#{template}">
		<ui:define name="label">#{label}</ui:define>
        <rich:fileUpload
          id="#{id}"
          execute="@this"
          status=":status"
          limitRender="true"
          required="#{wi:get(required, false)}"
          fileUploadListener="#{fileUpload.processFileUpload}"
          addLabel="#{infoxMessages['processoDocumento.addLabel']}"
          clearAllLabel="#{infoxMessages['processoDocumento.clearAllLabel']}"
          clearLabel="#{infoxMessages['processoDocumento.clearLabel']}"
          doneLabel="#{empty doneLabel ? infoxMessages['processoDocumento.doneLabel'] : doneLabel}"
          uploadLabel="#{infoxMessages['processoDocumento.uploadLabel']}"
          sizeExceededLabel="#{infoxMessages['processoDocumento.sizeExceededLabel']}"
          maxFilesQuantity="10"
          listHeight="50px"
          immediateUpload="true"
          noDuplicate="true"
          render="#{id}Decoration, #{id}, pageBodyDialogMessage, #{f.id}TipoDocDiv, #{f.id}documentoExistente, assinaturaDocumentoDiv#{f.id}"
          acceptedTypes="#{taskInstanceHome.variaveisDocumento[id].classificacaoDocumento.acceptedTypes}"
          rendered="#{not empty taskInstanceHome.variaveisDocumento[id].classificacaoDocumento and not readonly}"
          ontyperejected="new infox.Messages({'timeout': 3000}).dialog(\'#{infoxMessages['processoDocumento.extensaoNaoPermitida']}\')">
        </rich:fileUpload>
    </s:decorate>
    <s:div id="#{f.id}documentoExistente">
        <s:fragment rendered="#{not empty taskInstanceHome.instance[id]}">    
            <fieldset>
                <legend>Documento Anexado #{not empty taskInstanceHome.variaveisDocumento[id].documentoBin.assinaturas ? '(já assinado, não pode ser substituído)' : ''}</legend>
                <h:outputText value="#{infoxMessages['processoDocumento.classificacaoDocumento']}: #{not readonly or not empty taskInstanceHome.variaveisDocumento[id] ? taskInstanceHome.variaveisDocumento[id].classificacaoDocumento.descricao : props.classificacaoDocumento}"/>
                <br />
                <h:outputText id="file#{id}" value="Documento: #{not readonly or not empty taskInstanceHome.variaveisDocumento[id] ? taskInstanceHome.variaveisDocumento[id].documentoBin.nomeArquivo : value}"/>
               	<h:graphicImage url="#{wiSkin.imageFolder}/show.gif" title="Visualizar" style="cursor: pointer" rendered="#{not readonly or not empty taskInstanceHome.variaveisDocumento[id]}"
                				onclick="infox.openPopUp('documento', '#{taskInstanceHome.getViewUrlDownload(id.split('-')[0])}');" />
            </fieldset>
        </s:fragment>
    </s:div>
    <s:div id="assinaturaDocumentoDiv#{f.id}" >
	    <s:div id="conteudoAssinatura#{f.id}" rendered="#{taskInstanceHome.podeAssinarDocumento(f.id.split('-')[0])}">
			<a:jsFunction name="assinar"
				action="#{taskInstanceHome.assinarDocumento()}"
				execute="@this, assinaturaDocumentoDiv#{f.id}"
				render="assinaturaDocumentoDiv#{f.id}, pageBodyDialogMessage, #{f.id}TipoDocDiv, #{f.id}ToolTipDivExterna, #{id}Decoration, #{f.id}documentoExistente"
				oncomplete="infox.hideLoading();"/>
				
			<wi:certificadoDigital
	            id="appletAssinatura"
				signButtonCaption="#{infoxMessages['assinaturas.assinar']}"
				reRender="pageBodyDialogMessage, @form"
				tokenField="#{taskInstanceHome.tokenToSign}"
				propertyValue="#{f.id}"
				propertyTarget="#{taskInstanceHome.variavelDocumentoToSign}"
				signableData="#{taskInstanceHome.documentoToSign.documentoBin.md5Documento}"
				functionPreSign="infox.showLoading();"
				functionPosSign="assinar();" >
	       </wi:certificadoDigital>
		</s:div>
	</s:div>
  </f:subview>
</ui:composition>