<?xml version="1.0" encoding="UTF-8"?>

<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:s="http://jboss.org/schema/seam/taglib"
    xmlns:wi="http://www.itx.com.br/jsf">
    <ui:param name="editorId" value="#{id}Editor" />
    <ui:param name="idSignature" value="#{id}signature" />
    <ui:param name="idCertChain" value="#{id}certChain" />

    <s:div id="#{f.id}TipoDocDiv">
        <wi:selectOneMenuEntity id="tipoProcessoDocumento"
            label="#{messages['processoDocumento.classificacaoDocumento']}"
            value="#{processoHome.tipoProcessoDocumento}"
            items="#{classificacaoDocumentoFacade.getUseableTipoProcessoDocumento(true)}"
            required="true" showLabelSelecione="true" readonly="#{not empty processoHome.signature}">
            <a:ajax event="change" render="appletDiv" execute="@this" limitRender="true"/>
        </wi:selectOneMenuEntity>
    </s:div>

    <s:div id="#{id}EditorDiv">
        <wi:editor id="#{editorId}" value="#{home.instance[id]}" readonly="#{not empty processoHome.signature}"/>
    </s:div>

    <a:jsFunction name="submitForm" action="#{home.assinarDocumento()}"
        render="signatureDiv appletDiv #{id}EditorDiv pageBodyDialogMessage"
        oncomplete="infox.editor['#{id}Editor'].postSign()" />
    <s:div id="signatureDiv">
        <h:inputHidden id="#{idCertChain}"
            value="#{processoHome.certChain}" />
        <h:inputHidden id="#{idSignature}"
            value="#{processoHome.signature}" />
    </s:div>
    <s:div id="appletDiv" styleClass="applet-div">
        <wi:appletAssinatura id="#{id}"
            urlDownloadFile="#{pathResolver.urlProject}/downloadCaList.seam"
            formId="#{rich:clientId('taskInstanceForm')}"
            certificationChainField="#{rich:clientId(idCertChain)}"
            signatureField="#{rich:clientId(idSignature)}"
            getDataFunction="infox.editor['#{editorId}'].instance.getData()"
            useBase64Function="infox.editor['#{editorId}'].useBase64()"
            functionPreSign="infox.showLoading();"
            functionPosSign="submitForm()" debug="false"
            loginMode="false" useProviderDll="false"
            rendered="#{taskInstanceHome.podeRenderizarApplet()}">
        </wi:appletAssinatura>
    </s:div>
    <script type="text/javascript">
			namespace("infox.editor.#{editorId}",{
				useBase64:function useBase64() {
					return "true";
				},
				get isSigned() {
					return ((#{rich:jQuery(idSignature)}.val().trim() != "") 
							&amp;&amp; (#{rich:jQuery(idCertChain)}.val().trim() != "")) 
				},
				addSignature:function addSignature() {
					infox.showLoading();
					submitForm();
				},
				postSign:function postSign() {
					infox.hideLoading();
					if (this.isSigned) {
						#{rich:jQuery("appletDiv")}.addClass("hidden");
					}
				},
				sign:function sign() {
					#{rich:jQuery(idSignature)}.val("signature");
					#{rich:jQuery(idCertChain)}.val("certChain");
					this.addSignature();
				}
			},{
				callback:function callback(Editor) {
					Editor.instance.on("saveSnapshot", function onSaveSnapshot(ev) {
						#{rich:jQuery(idSignature)}.val("");
						#{rich:jQuery(idCertChain)}.val("");
						#{rich:jQuery("appletDiv")}.removeClass("hidden");
					});
				}
			});
		</script>

</ui:composition>
