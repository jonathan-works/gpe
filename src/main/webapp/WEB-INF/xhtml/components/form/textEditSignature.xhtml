<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:a="http://richfaces.org/a4j"
  xmlns:c="http://java.sun.com/jsp/jstl/core"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:rich="http://richfaces.org/rich"
  xmlns:s="http://jboss.org/schema/seam/taglib"
  xmlns:wi="http://www.itx.com.br/jsf">
  <ui:param
    name="editorId"
    value="#{id}Editor" />
  <ui:param
    name="idSignature"
    value="#{id}signature" />
  <ui:param
    name="idCertChain"
    value="#{id}certChain" />
  <f:subview id="#{f.id}SubView">
    <s:div id="#{f.id}TipoDocDiv">
      <wi:selectOneMenuEntity
        id="#{f.id}tipoProcessoDocumento"
        label="#{messages['processoDocumento.classificacaoDocumento']}"
        value="#{home.documentosAssinaveis[id].classificacao}"
        items="#{classificacaoDocumentoFacade.getUseableTipoProcessoDocumento(true)}"
        required="#{not readonly}"
        showLabelSelecione="true"
        readonly="#{readonly or home.possuiAssinatura(id)}"
        disabled="#{readonly or home.possuiAssinatura(id)}">
        <a:ajax
          event="change"
          render="appletDiv"
          execute="@this"
          limitRender="true" />
      </wi:selectOneMenuEntity>
    </s:div>
    <s:div id="#{id}EditorDiv">
      <wi:editor
        id="#{editorId}"
        value="#{home.instance[id]}"
        readonly="#{readonly or home.possuiAssinatura(id)}" />
    </s:div>
    <a:jsFunction
      name="#{editorId.replace('-', '')}submitForm"
      action="#{home.assinarDocumento(id)}"
      rendered="#{not readonly and home.podeRenderizarApplet(id)}"
      render="@form pageBodyDialogMessage"
      oncomplete="infox.hideLoading();" />
    <s:div
      id="signatureDiv"
      rendered="#{not readonly and home.podeRenderizarApplet(id)}">
      <h:inputHidden
        id="#{idCertChain}"
        value="#{home.documentosAssinaveis[id].certChain}" />
      <h:inputHidden
        id="#{idSignature}"
        value="#{home.documentosAssinaveis[id].signature}" />
    </s:div>
    <s:div
      id="appletDiv"
      styleClass="applet-div"
      rendered="#{not readonly}">
      <wi:appletAssinatura
        id="#{id}"
        urlDownloadFile="#{pathResolver.urlProject}/downloadCaList.seam"
        formId="#{rich:clientId('taskInstanceForm')}"
        certificationChainField="#{rich:clientId(idCertChain)}"
        signatureField="#{rich:clientId(idSignature)}"
        getDataFunction="infox.editor['#{editorId}'].instance.getData()"
        useBase64Function="infox.editor['#{editorId}'].useBase64()"
        functionPreSign="infox.showLoading();"
        functionPosSign="#{editorId.replace('-', '')}submitForm()"
        debug="false"
        loginMode="false"
        useProviderDll="false"
        rendered="#{home.podeRenderizarApplet(id)}">
      </wi:appletAssinatura>
    </s:div>
    <h:outputScript rendered="#{not readonly and home.podeRenderizarApplet(id)}">
			namespace("infox.editor.#{editorId}",{
				useBase64:function useBase64() {
					return "true";
				},
				get isSigned() {
					return ((#{rich:jQuery(idSignature)}.val().trim() != "") 
							&amp;&amp; (#{rich:jQuery(idCertChain)}.val().trim() != "")) 
				},
				addSignature:function addSignature() {
					infox.showLoading();
						#{editorId.replace('-', '')}submitForm();
				},
				postSign:function postSign() {
					infox.hideLoading();
				},
				sign:function sign() {
					#{rich:jQuery(idSignature)}.val("signature");
					#{rich:jQuery(idCertChain)}.val("certChain");
					this.addSignature();
				}
			},{
				callback:function callback(Editor) {
					Editor.instance.on("saveSnapshot", function onSaveSnapshot(ev) {
						#{rich:jQuery(idSignature)}.val("");
						#{rich:jQuery(idCertChain)}.val("");
						#{rich:jQuery("appletDiv")}.removeClass("hidden");
					});
				}
			});
		</h:outputScript>
  </f:subview>
</ui:composition>
