<?xml version="1.0" encoding="UTF-8"?>
<!--
  IBPM - Ferramenta de produtividade Java
  Copyright (c) 1986-2009 Infox Tecnologia da Informação Ltda.
 
  Este programa é software livre; você pode redistribuí-lo e/ou modificá-lo 
  sob os termos da GNU GENERAL PUBLIC LICENSE (GPL) conforme publicada pela 
  Free Software Foundation; versão 2 da Licença.
  Este programa é distribuído na expectativa de que seja útil, porém, SEM 
  NENHUMA GARANTIA; nem mesmo a garantia implícita de COMERCIABILIDADE OU 
  ADEQUAÇÃO A UMA FINALIDADE ESPECÍFICA.
  
  Consulte a GNU GPL para mais detalhes.
  Você deve ter recebido uma cópia da GNU GPL junto com este programa; se não, 
  veja em http://www.gnu.org/licenses/  
-->
<ui:composition
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:a="http://richfaces.org/a4j"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:s="http://jboss.org/schema/seam/taglib"
	xmlns:wi="http://www.itx.com.br/jsf"
>
	<ui:param name="editorId" value="#{id}Editor" />
	<ui:param name="idSignature" value="#{id}signature" />
	<ui:param name="idCertChain" value="#{id}certChain" />
	
	<wi:selectOneMenuEntity
		id="tipoProcessoDocumento"
		label="#{processoDocumentoHome.labelTipoProcessoDocumento()}"
		value="#{processoHome.tipoProcessoDocumento}"
		items="#{tipoProcessoDocumentoHome.getTipoProcessoDocumentoInterno(processoDocumentoHome.modelo)}"
		required="true"
		noSelectionLabel="Selecione..."
	>
	</wi:selectOneMenuEntity>
		
	<s:div id="editorDiv">
		<wi:editor
			id="#{editorId}"
			value="#{home.instance[f.id]}"
		/>
	</s:div>
	
	<a:jsFunction
		name="submitForm"
		action="#{home.assinarDocumento()}"
		render="signatureDiv pageBodyDialogMessage"
		oncomplete="infox.editor['#{id}Editor'].postSign()"
	/>
	<s:div id="signatureDiv">
		<h:inputHidden
			id="#{idCertChain}"
			value="#{processoHome.certChain}"
		/>
		<h:inputHidden
			id="#{idSignature}"
			value="#{processoHome.signature}"
		/>
	</s:div>
	<s:div id="appletDiv" styleClass="applet-div">
		<wi:appletAssinatura
			id="#{id}"
			urlDownloadFile="#{util.urlProject}/downloadCaList.seam"
			formId="#{rich:clientId('taskInstanceForm')}"
			certificationChainField="#{rich:clientId(idCertChain)}"
			signatureField="#{rich:clientId(idSignature)}"
			getDataFunction="infox.editor['#{editorId}'].instance.getData()"
			useBase64Function="infox.editor['#{editorId}'].useBase64()"
			functionPreSign="infox.editor['#{editorId}'].addSignature()"
			functionPosSign=""
			debug="false"
			loginMode="false"
			useProviderDll="false"
		>
		</wi:appletAssinatura>
	</s:div>
		<script type="text/javascript">
			//<![CDATA[
			namespace("infox.editor.#{editorId}",{
				useBase64:function useBase64() {
					return "true";
				},
				get isSigned() {
					return ((#{rich:jQuery(idSignature)}.val().trim() != "") 
							&& (#{rich:jQuery(idCertChain)}.val().trim() != "")) 
				},
				addSignature:function addSignature() {
					infox.showLoading();
					submitForm();
				},
				postSign:function postSign() {
					infox.hideLoading();
					if (this.isSigned) {
						#{rich:jQuery("appletDiv")}.addClass("hidden");
					}
				},
				sign:function sign() {
					#{rich:jQuery(idSignature)}.val("signature");
					#{rich:jQuery(idCertChain)}.val("certChain");
					this.addSignature();
				}
			},{
				callback:function callback(Editor) {
					Editor.instance.on("saveSnapshot", function onSaveSnapshot(ev) {
						#{rich:jQuery(idSignature)}.val("");
						#{rich:jQuery(idCertChain)}.val("");
						#{rich:jQuery("appletDiv")}.removeClass("hidden");
					});
				}
			});
			//]]>
		</script>

</ui:composition>
