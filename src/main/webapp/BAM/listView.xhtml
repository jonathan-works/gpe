<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:wi="http://www.itx.com.br/jsf"
  xmlns:rich="http://richfaces.org/rich"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:c="http://java.sun.com/jsp/jstl/core"
  xmlns:s="http://jboss.org/schema/seam/taglib"
  xmlns:a="http://richfaces.org/a4j"
  xmlns:dojo="http://www.itx.com.br/dojo"
  template="/WEB-INF/xhtml/templates/core/defaultTemplate.xhtml"
>
  <ui:define name="title">#{infoxMessages['bam.pageTitle']}</ui:define>
  <ui:param
    name="home"
    value="#{bamAction}"
  />
  <ui:param
    name="showFormTab"
    value="#{not empty processoTarefaList.entity.processo}"
  />
  <ui:define name="head">
    <h:outputScript
      name="dojo.js"
      library="js/dojo"
    />
    <h:outputScript
      name="defaultGauge.js"
      library="js/dojoCustom/gauges"
    />
    <h:outputScript
      name="progressBarGauge.js"
      library="js/dojoCustom/gauges"
    />
  </ui:define>
  <ui:define name="searchGrid">
    <wi:dataTable
      values="#{processoEpaNaoFinalizadoList.list(15)}"
      bean="#{processoEpaNaoFinalizadoList}"
      tableTitle="#{infoxMessages['bam.tableTitle']}"
      id="processoEpaNaoFinalizadoList"
      rowId="#{row.idProcessoTarefa}"
      toolBarColumnWidth="69px"
      hideOrder="true"
    >
      <ui:define name="searchForm">
        <wi:searchForm
          formId="pesquisaFluxoForm"
          formTitle="#{infoxMessages['searchForm.title']}"
        >
          <wi:selectOneMenuEntity
            id="comboFluxo"
            value="#{processoEpaNaoFinalizadoList.fluxo}"
            label="#{infoxMessages['naturezaCategoriaFluxo.fluxo']}"
            items="#{processoEpaNaoFinalizadoList.fluxoList}"
          />
          <wi:selectOneMenuEnum
            id="tipoDeprocesso"
            label="#{infoxMessages['bam.tipoAtraso']}"
            items="#{processoEpaNaoFinalizadoList.getTiposSituacaoPrazo()}"
            value="#{processoEpaNaoFinalizadoList.entity.processo.situacaoPrazo}"
          />
        </wi:searchForm>
        <dojo:defaultGauge
          id="processo"
          max="#{processoEpaNaoFinalizadoList.fluxo.qtPrazo}"
          width="250"
          height="200"
          radius="50"
          label="#{infoxMessages['bam.medidorProcSel']}"
          draggable="false"
          indicatorLabel="#{infoxMessages['bam.tempoMedio']}"
          value="#{processoEpaNaoFinalizadoList.mediaTempoGastoDesdeInicioProcesso}"
        />
      </ui:define>
      <ui:define name="headerToolBar" />
      <ui:define name="toolBar">
        <div class="tbar-div">
          <h:graphicImage
            value="#{wiSkin.imageFolder}/mod/balao.png"
            rendered="#{row.processo.situacaoPrazo ne 'SAT'}"
          />
          <wi:toolBarEdit
            action="#{processoTarefaList.entity.setProcesso(row.processo)}"
          />
        </div>
      </ui:define>
      <wi:columnOutputText
        columnId="numeroProcesso"
        columnHeader="#{infoxMessages['processo.menuText']}"
        value="#{row.processo.numeroProcessoRoot}"
        hideOrder="true"
      />
      <wi:columnOutputText
        columnId="fluxo"
        columnHeader="#{infoxMessages['naturezaCategoriaFluxo.fluxo']}"
        value="#{row.processo.naturezaCategoriaFluxo.fluxo}"
        hideOrder="true"
      />
      <wi:columnDateTime
        columnId="dataInicio"
        columnHeader="#{infoxMessages['processo.dataInicio']}"
        value="#{row.processo.dataInicio}"
      />
      <wi:columnOutputText
        columnId="naturezaCategoriaItem"
        columnHeader="#{infoxMessages['processoEpa.naturezaCategoriaItem']}"
        value="#{processoEpaNaoFinalizadoList.getNaturezaCategoriaItem(row.processo)}"
        hideOrder="true"
      />
      <wi:columnOutputText
        columnId="prioridadeProcesso"
        columnHeader="#{infoxMessages['bam.prioridade']}"
        value="#{row.processo.prioridadeProcesso}"
      />
      <wi:columnDateTime
        columnId="dataChegadaTarefa"
        columnHeader="#{infoxMessages['processoEpa.dataChegadaTarefa']}"
        value="#{row.dataInicio}"
      />
      <ui:param
        name="task"
        value="#{bamAction.getTaskInstance(row.taskInstance)}"
      />
      <rich:column styleClass="defaultCell">
        <f:facet name="header">#{infoxMessages['localizacao.localizacao']} / #{infoxMessages['usuario.usuario']}</f:facet>
        <span> <h:graphicImage
            url="#{wiSkin.imageFolder}/localizacao.gif"
            rendered="#{!empty jbpmUtil.getLocalizacao(task)}"
          /> <h:outputText value="#{jbpmUtil.getLocalizacao(task)}" />
        </span>
        <span> <h:graphicImage
            url="#{wiSkin.imageFolder}/usuario.gif"
            rendered="#{!empty userHandler.getUsuario(task.actorId)}"
          /> <h:outputText
            value=" #{userHandler.getUsuario(task.actorId)}"
          />
        </span>
      </rich:column>
      <wi:columnOutputText
        columnId="tempoGastoTarefa"
        columnHeader="#{infoxMessages['processoEpa.tempoGastoTarefa']}"
        value="#{row.tempoGastoFormatado}"
      />
      <wi:columnOutputText
        columnId="tempoDesdeInicio"
        columnHeader="#{infoxMessages['processoEpa.tempoDesdeInicioDias']}"
        value="#{processoEpaNaoFinalizadoList.getDiasDesdeInicioProcesso(row.processo)}"
        hideOrder="true"
      />
    </wi:dataTable>
  </ui:define>
  <ui:define name="form">
    <dojo:defaultGauge
      id="#{processoTarefaList.entity.processo.numeroProcessoRoot}"
      max="#{processoEpaNaoFinalizadoList.fluxo.qtPrazo}"
      width="210"
      height="200"
      radius="50"
      label="#{processoEpaNaoFinalizadoList.fluxo.fluxo}"
      draggable="true"
      containerStyleClass="organized"
      indicatorLabel="#{infoxMessages['processoEpa.tempoGasto']} (dias)"
      value="#{processoEpaTarefaList.diasDesdeInicioProcesso}"
    />
    <wi:dataTable
      values="#{processoTarefaList.list(15)}"
      bean="#{processoTarefaList}"
      tableTitle="Processo #{processoTarefaList.entity.processo.numeroProcessoRoot} - Tarefas"
      showToolbarColumn="false"
      showSearchForm="false"
      panelStyleClass="bam-table"
      showGrid="#{not empty processoTarefaList.entity.processo}"
      id="processoTarefaDataTable"
    >
      <ui:define name="toolBar"></ui:define>
      <ui:define name="headerToolBar"></ui:define>
      <wi:columnOutputText
        columnId="medidor"
        columnHeader="#{infoxMessages['bam.medidor']}"
        hideOrder="true"
        columnWidth="60"
      >
        <dojo:progressBarGauge
          id="#{row.idProcessoTarefa}"
          width="60"
          height="13"
          barWidth="60"
          barHeight="13"
          min="0"
          max="100"
          value="#{row.porcentagem}"
          hideTicks="true"
        >
        </dojo:progressBarGauge>
      </wi:columnOutputText>
      <wi:columnOutputText
        columnId="tarefa"
        columnHeader="Tarefa"
        value="#{row.tarefa.tarefa}"
      />
      <ui:param
        name="task"
        value="#{bamAction.getTaskInstance(row.taskInstance)}"
      />
      <rich:column styleClass="defaultCell">
        <f:facet name="header">#{infoxMessages['localizacao.localizacao']} / #{infoxMessages['usuario.usuario']}</f:facet>
        <span> <h:graphicImage
            url="#{wiSkin.imageFolder}/localizacao.gif"
            rendered="#{!empty jbpmUtil.getLocalizacao(task)}"
          /> <h:outputText value="#{jbpmUtil.getLocalizacao(task)}" />
        </span>
        <span> <h:graphicImage
            url="#{wiSkin.imageFolder}/usuario.gif"
            rendered="#{!empty userHandler.getUsuarioByTaskInstance(task)}"
          /> <h:outputText
            value=" #{userHandler.getUsuarioByTaskInstance(task)}"
          />
        </span>
      </rich:column>
      <ui:param
        name="prazoEstourado"
        value="#{row.porcentagem > 100}"
      />
      <ui:param
        name="porc"
        value="#{prazoEstourado ? '> 100' : row.porcentagem}"
      />
      <wi:columnOutputText
        columnId="porcentagem"
        columnHeader="%"
        value="#{not empty porc ? (porc != -1 ? ''.concat(porc).concat('%') : '-') : '0%'}"
      />
      <rich:column styleClass="defaultCell">
        <f:facet name="header">#{infoxMessages['processo.dataInicio']}</f:facet>
        <h:outputText value="#{row.dataInicio}">
          <s:convertDateTime pattern="dd/MM/yy kk:mm:ss" />
        </h:outputText>
      </rich:column>
      <rich:column styleClass="defaultCell">
        <f:facet name="header">#{infoxMessages['processo.dataFim']}</f:facet>
        <h:outputText value="#{row.dataFim}">
          <s:convertDateTime pattern="dd/MM/yy kk:mm:ss" />
        </h:outputText>
      </rich:column>
      <wi:columnOutputText
        columnId="tempoGasto"
        columnHeader="#{infoxMessages['processoEpa.tempoGasto']}"
        value="#{row.getTempoGastoFormatado()}"
      />
      <wi:columnOutputText
        columnId="tempoPrevisto"
        columnHeader="#{infoxMessages['temposMedios.prazo']}"
        value="#{row.tarefa.prazo} #{row.tarefa.tipoPrazo.getLabel()}"
      />
    </wi:dataTable>
  </ui:define>
</ui:composition>
