<?xml version="1.0" encoding="ISO-8859-1"?>

<!--
  IBPM - Ferramenta de produtividade Java
  Copyright (c) 1986-2009 Infox Tecnologia da Informação Ltda.
 
  Este programa é software livre; você pode redistribuí-lo e/ou modificá-lo 
  sob os termos da GNU GENERAL PUBLIC LICENSE (GPL) conforme publicada pela 
  Free Software Foundation; versão 2 da Licença.
  Este programa é distribuído na expectativa de que seja útil, porém, SEM 
  NENHUMA GARANTIA; nem mesmo a garantia implícita de COMERCIABILIDADE OU 
  ADEQUAÇÃO A UMA FINALIDADE ESPECÍFICA.
  
  Consulte a GNU GPL para mais detalhes.
  Você deve ter recebido uma cópia da GNU GPL junto com este programa; se não, 
  veja em http://www.gnu.org/licenses/  
-->
    
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
			    xmlns:ui="http://java.sun.com/jsf/facelets"
				xmlns:wi= "http://www.itx.com.br/jsf"
				xmlns:rich="http://richfaces.ajax4jsf.org/rich"
				xmlns:f="http://java.sun.com/jsf/core"
				xmlns:h="http://java.sun.com/jsf/html"
				xmlns:c="http://java.sun.com/jstl/core"
				xmlns:s="http://jboss.com/products/seam/taglib"
				xmlns:a="http://richfaces.org/a4j"
				xmlns:dojo="http://www.itx.com.br/dojo"
			    template="/WEB-INF/xhtml/templates/core/menuTemplate.xhtml">
                       
	<ui:define name="title">BAM</ui:define>

	<ui:define name="body">
		<style>
			.circ {
				width:15px;
				height:15px;
				border:0px;
				border-radius:15px;
                position:relative;
                left: 10px;
			}
			
			.yellow-back {
				background-color: yellow;
			}
			
			.red-back {
				background-color: red;
			}
		</style>
		
		<wi:dataForm formId="pesquisaFluxoForm"
					 formTitle="Pesquisar Fluxo"
					 requiredForm="false">
					 
			 <wi:inputText value="#{processoEpaNaoFinalizadoList.fluxoName}" styleDiv="margin:0px; padding-right: 0px" id="statesinput" />
             <h:graphicImage value="/img/arrow.png"
                 onclick="#{rich:component('suggestion')}.callSuggestion(true)"
                 alt="" />
					 
			<rich:suggestionbox id="suggestion" 
								height="200"  
								width="250" 
					            suggestionAction="#{bamAction.getFluxoSuggest}" 
					            var="row"
					            for="statesinput"
					            fetchValue="#{row.fluxo}">
	            <h:column>
	                <h:graphicImage value="/img/balao.png" rendered="#{bamAction.contemProcessoAtrasado(row)}" />
	            </h:column>
	            <h:column>
	                <h:outputText value="#{row.fluxo}" />
	            </h:column>
	        </rich:suggestionbox>
	        
	        <wi:commandButton id="pesquisar"
							  value="Pesquisar"
							  action="#{processoEpaNaoFinalizadoList.setFluxo(null)}"
							  reRender="processoList" />
								  
			<ui:define name="buttons"/>
		</wi:dataForm>
		
		<s:div id="processoList">
			<wi:dataTable values="#{processoEpaNaoFinalizadoList.list(15)}"
						  bean="#{processoEpaNaoFinalizadoList}"
						  tableTitle="Processos - Prazo: #{processoEpaNaoFinalizadoList.fluxo.qtPrazo} (dias)"
						  showGrid="#{not empty processoEpaNaoFinalizadoList.fluxo}"
						  panelWidth="100%"
						  onRowMouseOut=""
						  onRowMouseOver=""
						  id="processoDataTable">
						  
				<ui:define name="headerToolBar" />
				<ui:define name="toolBar"> 
					<div class="circ #{row.porcentagem > 100 ? 'red-back' : (processoEpaNaoFinalizadoList.contemTarefaForaPrazo(row) ? 'yellow-back' : '')}">
    					<wi:toolBar url="/img/edit.gif"
    								action="processoEpaTarefaList.entity.setProcessoEpa(row)"
    								oncomplete="Richfaces.showModalPanel('processoEpaTarefaModal')"
    								reRender="processoEpaTarefaModal"/>
                    </div>
				</ui:define>
				
				<wi:columnOutputText columnId="medidor"
									 columnHeader="Medidor"
									 hideOrder="true"
									 columnWidth="60">
					<dojo:defaultGauge id="#{row.numeroProcesso}"
										radius="15"
										width="40"
										height="40"
										max="#{processoEpaNaoFinalizadoList.fluxo.qtPrazo}"
										value="#{row.tempoGasto}"/>
				</wi:columnOutputText>
				
				<wi:columnOutputText columnId="numeroProcesso"
									 columnHeader="Número do Processo"
									 value="#{row.numeroProcesso}" />
									 
				<wi:columnOutputText columnId="tempoGasto"
									 columnHeader="Tempo Gasto (em dias)"
									 value="#{row.tempoGasto}" />
									 
				<ui:param name="porc" value="#{row.porcentagem > 100 ? '> 100' : row.porcentagem}" />
				<wi:columnOutputText columnId="porcentagem"
									 columnHeader="Porcentagem"
									 value="#{not empty row.porcentagem ? porc : 0}%" />
				
			</wi:dataTable>
		</s:div>
		
		<wi:modalPanel id="processoEpaTarefaModal"
					   labelHeader="Detalhe do Processo"
					   width="800"
					   height="400">
			<wi:dataTable values="#{processoEpaTarefaList.list(15)}"
						  bean="#{processoEpaTarefaList}"
						  tableTitle="Tarefas"
						  showToolbarColumn="false" 
						  panelWidth="97%"
						  showGrid="#{not empty processoEpaTarefaList.entity.processoEpa}"
						  rowClasses="#{processoEpaTarefaList.rowClasses()}"
						  onRowMouseOut=""
						  onRowMouseOver=""
						  id="processoTarefaDataTable">
				<wi:columnOutputText columnId="medidor"
									 columnHeader="Medidor"
									 hideOrder="true"
									 columnWidth="60">
					<dojo:defaultGauge id="#{row.tarefa.idTarefa}"
										radius="15"
										width="40"
										height="40"
										max="#{row.tempoPrevisto}"
										value="#{row.tempoGasto}"/>
				</wi:columnOutputText>
				
				<wi:columnOutputText columnId="tarefa"
									 columnHeader="Tarefa"
									 value="#{row.tarefa.tarefa}" />
									 
				<ui:param name="task" value="#{bamAction.getTaskInstance(row.taskInstance)}"	/>  
				<rich:column styleClass="defaultCell">
					<f:facet name="header">Localização / Usuário</f:facet>
					<div style="width:50%; float:left">
						<h:graphicImage url="/img/localizacao.gif"
										rendered="#{!empty jbpmUtil.getLocalizacao(task)}" />
						<h:outputText value="#{jbpmUtil.getLocalizacao(task)}" />
					</div>
					<div style="width:50%; float:left">
						<h:graphicImage url="/img/usuario.gif"
										rendered="#{!empty userHandler.getUsuario(task.actorId)}" />
						<h:outputText value=" #{userHandler.getUsuario(task.actorId)}" />
					<c:if test="#{empty userHandler.getUsuario(task.actorId)}">
						<h:outputText value="#{userHandler.getUsuarioByTarefa(task)}" />
					</c:if>
					</div>
				</rich:column>
				
				<ui:param name="prazoEstourado" value="#{row.porcentagem > 100}" />
				<ui:param name="porc" value="#{prazoEstourado ? '> 100' : row.porcentagem}" />
				<wi:columnOutputText columnId="porcentagem"
									 columnHeader="Porcentagem"
									 value="#{not empty porc ? (porc != -1 ? ''.concat(porc).concat('%') : '-') : '0%'}" />
									 
									 
				<rich:column style="text-align: center" 
							 styleClass="defaultCell">
					<f:facet name="header">Início</f:facet>
					<h:outputText value="#{row.dataInicio}">
						<s:convertDateTime pattern="dd/MM/yy kk:mm:ss" />
					</h:outputText>
				</rich:column>
				
				<rich:column style="text-align: center" 
							 styleClass="defaultCell">
					<f:facet name="header">Término</f:facet>
					<h:outputText value="#{row.dataFim}">
						<s:convertDateTime pattern="dd/MM/yy kk:mm:ss" />
					</h:outputText>
				</rich:column>
				
				<wi:columnOutputText columnId="tempoGasto"
									 columnHeader="Tempo Gasto"
									 value="#{row.tempoGasto}  (#{processoEpaTarefa.tarefa.tipoPrazo == 'D' ? 'dias' : 'minutos'})" />
									 
				<wi:columnOutputText columnId="tempoPrevisto"
									 columnHeader="Tempo Previsto"
									 value="#{row.tempoPrevisto}  (#{processoEpaTarefa.tarefa.tipoPrazo == 'D' ? 'dias' : 'minutos'})" />
			</wi:dataTable>
		</wi:modalPanel>
	</ui:define>
	 
</ui:composition>