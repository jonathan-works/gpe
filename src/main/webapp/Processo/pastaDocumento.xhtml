<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:s="http://jboss.org/schema/seam/taglib"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:a="http://richfaces.org/a4j"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:rich="http://richfaces.org/rich"
  xmlns:wi="http://www.itx.com.br/jsf">
  
  <ui:param name="pastaDocumentoRenderId" value="#{empty pastaDocumentoRenderId ? '' : pastaDocumentoRenderId}" />
  <a:jsFunction
    name="selectDocumento"
    immediate="true"
    execute="@this"
    render="historicoDocumentoPanelDiv"
    limitRender="true"
    status=":status">
    <a:param
      name="idDocumento"
      assignTo="#{documentoProcessoAction.idDocumento}"
      converter="javax.faces.Integer" />
  </a:jsFunction>
  
  <rich:collapsiblePanel expanded="true" header="#{infoxMessages['searchForm.title']}" switchType="client">
  	<h:form>
		<h:outputText value="#{infoxMessages['documentoProcesso.classificacaoDocumento']}" styleClass="name"/>
		<h:selectOneMenu
		      id="classificacaoDocumento"
		      value="#{documentoProcessoAction.classificacaoDocumentoItem}"
		      styleClass="input select">
		      <f:ajax immediate="true" event="valueChange" execute="@form" render=":#{pastaDocumentoRenderId}:documentoListSearchForm :#{pastaDocumentoRenderId}:documentoListPanel @form"/>
		      <f:selectItem noSelectionOption="true" itemValue="#{null}" itemLabel="#{infoxMessages['crud.select.all']}" />
		      <f:selectItems value="#{documentoProcessoAction.listClassificacaoDocumento}" var="item" itemLabel="#{item.descricao}" itemValue="#{item.id}" />
		      <f:converter converterId="javax.faces.Integer"/>
		</h:selectOneMenu>
		
  	</h:form>
  </rich:collapsiblePanel>
  <div style="margin-top:5px;"/>
  <wi:dataTable
	  values="#{documentoList.list(15)}"
	  bean="#{documentoList}"
	  id="documentoList"
	  tableTitle="#{empty documentoList.entity.pasta ? '' : documentoList.entity.pasta.nome}"
	  rowId="#{row.id}"
	  showSearchForm="true">
	
	<ui:define name="searchForm">
		<rich:panel header="Pastas">
			<rich:list
				value="#{pastaAction.pastaList}"
				styleClass="folder-ul"
				rowClass="folder-li"
				var="pasta">
				<s:div rendered="#{s:hasPermission('/pages/Pasta/visualizarPasta', 'access') or pastaAction.canSee(pasta)}"
					styleClass="rf-tr-nd">
					<rich:dropTarget
						acceptedTypes="doc#{consultaController.processo.idProcesso}"
						dropListener="#{pastaAction.associaDocumento}"
						dropValue="#{pasta}"
						render="documentoListPanel, documentoListSearchForm"
						limitRender="true" />
					<a:commandLink
						render="documentoListPanel, documentoListSearchForm"
						execute="@form"
                        action="#{pastaAction.selectPasta(pasta)}"
						styleClass="folder"
						limitRender="true">
  		              <h:graphicImage
                          url="#{wiSkin.imageFolder}/folder.png"
                          rendered="true"
                          title="#{pasta}" />
						<h:outputText value="#{eventCache.get('pastaAction.getNomePasta(pasta)', pasta.id)}" class="folder" />
					</a:commandLink>
                    <a:commandLink
                      render="documentoListSearchForm"
                      execute="@form"
                      rendered="#{s:hasPermission('/pages/Pasta/editarPasta', 'access') and pastaAction.canEdit(pasta)}"
                      onmouseup="setValuesToEditPasta(#{pasta.id}, '#{pasta.nome}', #{pasta.visivelExterno}, #{pasta.visivelNaoParticipante});"
                      limitRender="true">
                      <h:graphicImage
                        styleClass="opacityHover"
                        url="#{wiSkin.imageFolder}/view.png"
                        rendered="true"
                        title="#{infoxMessages['button.selecionar']}" />
                    </a:commandLink>
                    <a:commandLink
                      render="documentoListSearchForm, pageBodyDialogMessage, documentoListPanel"
                      execute="@form"
                      action="#{pastaAction.remove(pasta)}"
                      rendered="#{s:hasPermission('/pages/Pasta/removerPasta', 'access') and pastaAction.canRemove(pasta)}"
                      limitRender="true">
                      <h:graphicImage
                        styleClass="opacityHover"
                        url="#{wiSkin.imageFolder}/remove.png"
                        rendered="true"
                        title="#{infoxMessages['button.delete']}" />
                    </a:commandLink>
				</s:div>
			</rich:list>
		</rich:panel>
		<wi:commandButton
			id="addPastaBtn"
			value="#{infoxMessages['documentoProcesso.addFolder']}"
			rendered="#{s:hasPermission('/pages/Pasta/adicionarPasta', 'access')}"
			onclick="#{rich:component('addPastaPanel')}.show();" />
	</ui:define>
	
		<ui:define name="toolBar">
	    <rich:dragSource
	      type="doc#{consultaController.processo.idProcesso}"
	      dragValue="#{row}"
	      rendered="#{s:hasPermission('/pages/Pasta/moverDocumento', 'access')}"
	      dragIndicator="indicator">
	      <rich:dragIndicator
	        id="indicator"
	        acceptClass="caixa-acpt"
	        draggingClass="caixa-drag"
	        rejectClass="caixa-rejt">
	        <span class="caixa-ind-lbl">#{row.descricao}</span>
	      </rich:dragIndicator>
	    </rich:dragSource>
	    <h:graphicImage
	      rendered="#{s:hasPermission('/pages/Pasta/moverDocumento', 'access')}"
	      url="#{wiSkin.imageFolder}/anexo.png"
	      title="#{infoxMessages['documentoProcesso.moverDocumento']}" />
	  <h:graphicImage
	    styleClass="opacityHover"
	    url="#{wiSkin.imageFolder}/view.png"
	    title="#{infoxMessages['button.historico']}"
	    rendered="#{documentoProcessoAction.hasHistoricoDocumento(rowId) and documentoProcessoAction.podeUsuarioVerHistorico()}"
	    onmouseup="selectDocumento(#{rowId});" />
	  <h:graphicImage
	    styleClass="opacityHover"
	    url="#{wiSkin.imageFolder}/remove.png"
	    rendered="#{not row.excluido and documentoProcessoAction.podeUsuarioExcluirRestaurar()}"
	    title="#{infoxMessages['button.delete']}"
	    onmouseup="#{rich:component('requestMotivoPanel')}.show(); setValuesToExcludeRestore(true, #{rowId}, #{row.numeroDocumento}, '#{row.descricao}', '#{row.classificacaoDocumento.descricao}');" />
	  <h:graphicImage
	    styleClass="opacityHover"
	    url="#{wiSkin.imageFolder}/stock_undelete.png"
	    rendered="#{row.excluido and documentoProcessoAction.podeUsuarioExcluirRestaurar()}"
	    title="#{infoxMessages['button.restaurar']}"
	    onmouseup="#{rich:component('requestMotivoPanel')}.show(); setValuesToExcludeRestore(false, #{rowId}, #{row.numeroDocumento}, '#{row.descricao}', '#{row.classificacaoDocumento.descricao}');" />
	  <h:form>
	     <ui:include src="/WEB-INF/xhtml/components/grid/processoDocumentoBin.xhtml">
	       <ui:param name="bin" value="#{row.documentoBin}" />
	       <ui:param name="header" value="#{row.descricao}" />
	     </ui:include>
	  </h:form>
    </ui:define>
    
    <ui:define name="headerToolBar" />

	<wi:columnOutputText
      styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
      columnId="numeroDocumento"
      columnHeader="#{infoxMessages['documentoProcesso.numeroDocumento']}"
      value="#{row.numeroDocumento}" />
    <wi:columnOutputText
      styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
      columnId="usuarioInclusao"
      columnHeader="#{infoxMessages['assinaturas.usuario']}"
      value="#{row.usuarioInclusao}" />
    <wi:columnOutputText
      styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
      columnId="dataInclusao"
      columnHeader="#{infoxMessages['assinaturas.dataInclusao']}"
      value="#{row.dataInclusao}" />
    <wi:columnOutputText
      styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
      columnId="classificacaoDocumento"
      columnHeader="#{infoxMessages['documentoProcesso.classificacaoDocumento']}"
      value="#{row.classificacaoDocumento}" />
    <wi:columnOutputText
      styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
      columnId="descricao"
      columnHeader="#{infoxMessages['documentoProcesso.descricao']}"
      value="#{row.descricao}" />
    <wi:columnOutputText
      styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
      columnId="processoDocumentoBin.sizeFormatado"
      columnHeader="#{infoxMessages['processoDocumento.tamanho']}"
      value="#{row.documentoBin.sizeFormatado}" />
  	</wi:dataTable>
  	<script type="text/javascript">
		  function clearFieldsExcludeRestore() {
		      var maxlength = 4000;
		      #{rich:jQuery('motivoExclusaoRestauracao')}.val('');
		      #{rich:jQuery('motivoExclusaoRestauracaocounterDiv')}.text('(0 / '+maxlength+')');
		      $('.errorFields.errors').remove();
		      $('.errors').removeClass('errors');
		  }
		  
		  function setValuesToExcludeRestore(isExclusao, idDocumento, numeroDocumento, dsDocumento, classificacao) {
		      #{rich:jQuery('hiddenIdDocumento')}.val(idDocumento);
		      #{rich:jQuery('numeroDocumento')}.text(numeroDocumento);
		      #{rich:jQuery('processoDocumento')}.text(dsDocumento);
		      #{rich:jQuery('tipoProcessoDocumentoOutPanel')}.text(classificacao);
		      if (isExclusao) {
		          $('.rf-pp-hdr.motivo-header > div').text('Exclusão de Documento');
		          #{rich:jQuery('excluirRestaurarDocButton')}.attr('value','Excluir');
		          alterarMotivoDaExlusaoRestauracao('Motivo da Exclusão');
		      } else {
		          $('.rf-pp-hdr.motivo-header > div').text('Restauração de Documento');
		          #{rich:jQuery('excluirRestaurarDocButton')}.attr('value', 'Restaurar');
		          alterarMotivoDaExlusaoRestauracao('Motivo da Restauração');
		      }
		  }
		
		  function alterarMotivoDaExlusaoRestauracao(label){
		      var labelTextArea = $('label[for=\''+#{rich:jQuery('motivoExclusaoRestauracao')}.attr('id')+'\']');
		      labelTextArea.text(label);
		      labelTextArea.append($("<span> * </span>").addClass("required"));
		  }
		
		  function atualizarOnValidationFailed() {
		      var teste = $('.rf-pp-hdr.motivo-header').children(0).text();
		      if (teste === 'Exclusão de Documento') {
		          #{rich:jQuery('excluirRestaurarDocButton')}.attr('value','Excluir');
		          alterarMotivoDaExlusaoRestauracao('Motivo da Exclusão');
		      } else {
		          #{rich:jQuery('excluirRestaurarDocButton')}.attr('value', 'Restaurar');
		          alterarMotivoDaExlusaoRestauracao('Motivo da Restauração');
		      }
		  }
		  
		  function clearAddPastaFields() {
	    		#{rich:jQuery('addPastaInputName')}.val('');
	    		#{rich:jQuery('addPastaInputName')}.val('');
	    		#{rich:jQuery('addPastaInputVisivelExterno')}.prop('checked', false);
	    		#{rich:jQuery('addPastaInputVisivelNaoParticipante')}.prop('checked', false);
	    		#{rich:jQuery('addPastaDivVisivelNaoParticipante')}.hide();
	    		$('.errorFields.errors').remove();
	    	    $('.errors').removeClass('errors');
    	  }
	        
        function setValuesToEditPasta(id, nome, visivelExterno, visivelNaoParticipante) {
			#{rich:component('editPastaPanel')}.show();
			#{rich:jQuery('hiddenIdPasta')}.val(id);
			#{rich:jQuery('editPastaInputName')}.val(nome);
			#{rich:jQuery('editPastaInputVisivelExterno')}.prop('checked', visivelExterno);
			#{rich:jQuery('editPastaInputVisivelNaoParticipante')}.prop('checked', visivelNaoParticipante);
			visivelExterno ? #{rich:jQuery('editPastaDivVisivelNaoParticipante')}.show() : #{rich:jQuery('editPastaDivVisivelNaoParticipante')}.hide();
		}
        
        function clearEditPastaFields() {
			#{rich:jQuery('hiddenIdPasta')}.val('');
			#{rich:jQuery('editPastaInputName')}.val('');
			#{rich:jQuery('editPastaInputVisivelExterno')}.prop('checked', false);
			#{rich:jQuery('editPastaInputVisivelNaoParticipante')}.prop('checked', false);
			$('.errorFields.errors').remove();
		    $('.errors').removeClass('errors');
		}
	</script>
    
    <rich:popupPanel
        id="addPastaPanel"
        moveable="true"
        show="false"
        resizeable="false"
        minWidth="310"
        minHeight="260"
        header="#{infoxMessages['pasta.add']}"
        onbeforehide="clearAddPastaFields();">
        <f:facet name="controls">
          <h:graphicImage
            id="pastaPanelCloseBtn"
            styleClass="mp-close"
            value="#{wiSkin.imageFolder}/closeMP.gif"
            onmouseup="#{rich:component('addPastaPanel')}.hide();" />
          </f:facet>
          <h:form id="addPastaForm">
            <wi:inputText
              id="addPastaInputName"
              value="#{pastaAction.nome}"
              required="true"
              maxlength="250"
              label="#{infoxMessages['pasta.nome']}">
            </wi:inputText>
            <wi:selectBooleanCheckbox
              id="addPastaInputVisivelExterno"
              value="#{pastaAction.visivelExterno}"
              onclick="#{rich:jQuery('addPastaInputVisivelExterno')}.prop('checked') ? #{rich:jQuery('addPastaDivVisivelNaoParticipante')}.show() : #{rich:jQuery('addPastaDivVisivelNaoParticipante')}.hide();"
              label="#{infoxMessages['pasta.usuarioExterno']}" />
            <s:div id="addPastaDivVisivelNaoParticipante" style="display: none">
              <wi:selectBooleanCheckbox
                id="addPastaInputVisivelNaoParticipante"
                value="#{pastaAction.visivelNaoParticipante}"
                label="#{infoxMessages['pasta.usuarioParticipante']}" />
            </s:div>
            <br />
            <wi:commandButton
              id="addPastaButton"
              action="#{pastaAction.persist()}"
              execute="@form"
              oncomplete="if(#{not facesContext.validationFailed}){#{rich:component('addPastaPanel')}.hide();}else{clearAddPastaFields()}"
              value="Adicionar"
              reRender="@form, documentoListSearchForm, pageBodyDialogMessage" />
          </h:form>
    </rich:popupPanel>
    
    <rich:popupPanel
      id="editPastaPanel"
      moveable="true"
      show="false"
      resizeable="false"
      minWidth="290"
      minHeight="260"
      header="#{infoxMessages['pasta.edit']}"
      onbeforehide="clearEditPastaFields();">
      <f:facet name="controls">
        <h:graphicImage
          id="editPastaPanelCloseBtn"
          styleClass="mp-close"
          value="#{wiSkin.imageFolder}/closeMP.gif"
          onmouseup="#{rich:component('editPastaPanel')}.hide();" />
      </f:facet>
      <h:form id="editPastaForm">
        <h:inputHidden
            id="hiddenIdPasta"
            value="#{pastaAction.id}"
            converter="javax.faces.Integer" />
        <wi:inputText
          id="editPastaInputName"
          value="#{pastaAction.nome}"
          required="true"
          maxlength="250"
          label="#{infoxMessages['pasta.nome']}">
        </wi:inputText>
        <wi:selectBooleanCheckbox
          id="editPastaInputVisivelExterno"
          value="#{pastaAction.visivelExterno}"
          onclick="#{rich:jQuery('editPastaInputVisivelExterno')}.prop('checked') ? #{rich:jQuery('editPastaDivVisivelNaoParticipante')}.show() : #{rich:jQuery('editPastaDivVisivelNaoParticipante')}.hide();"
          label="#{infoxMessages['pasta.usuarioExterno']}" />
        <s:div id="editPastaDivVisivelNaoParticipante" style="display: none">
          <wi:selectBooleanCheckbox
            id="editPastaInputVisivelNaoParticipante"
            value="#{pastaAction.visivelNaoParticipante}"
            label="#{infoxMessages['pasta.usuarioParticipante']}" />
        </s:div>
        <br />
        <wi:commandButton
          id="editPastaButton"
          action="#{pastaAction.update()}"
          execute="@form"
          oncomplete="if(#{not facesContext.validationFailed}){#{rich:component('editPastaPanel')}.hide();}else{clearEditPastaFields()}"
          value="#{infoxMessages['button.save']}"
          reRender="@form, documentoListSearchForm, pageBodyDialogMessage, documentoListPanel" />
      </h:form>
    </rich:popupPanel>
    
	<rich:popupPanel
	  id="requestMotivoPanel"
	  header="teste"
	  headerClass="motivo-header"
	  moveable="true"
	  show="false"
	  resizeable="true"
	  minWidth="690"
	  minHeight="310"
	  onbeforehide="clearFieldsExcludeRestore();">
	  <f:facet name="controls">
	    <h:graphicImage
	      id="mp_taskNodeCloseBtn"
	      styleClass="mp-close"
	      value="#{wiSkin.imageFolder}/closeMP.gif"
	      onmouseup="#{rich:component('requestMotivoPanel')}.hide();" />
	  </f:facet>
	  <wi:outputText
	    id="numeroDocumento"
	    label="#{infoxMessages['processoDocumento.numeroDocumento']}" />
	
	  <wi:outputText
	    id="tipoProcessoDocumentoOutPanel"
	    label="#{infoxMessages['tipoProcessoDocumento.tipoProcessoDocumento']}" />
	
	  <wi:outputText
	    id="processoDocumento"
	    label="#{infoxMessages['processoDocumentoBin.documento']}" />
	  <h:form id="excluirRestaurarDocumentoForm">
	    <div>
	      <h:inputHidden
	        id="hiddenIdDocumento"
	        value="#{documentoProcessoAction.idDocumentoAlter}"
	        converter="javax.faces.Integer" />
	      <wi:inputTextarea
	        id="motivoExclusaoRestauracao"
	        maxlength="4000"
	        required="true"
	        cols="60"
	        rows="5"
	        label="Motivo"
	        value="#{documentoProcessoAction.motivoExclusaoRestauracao}">
	        <f:validator validatorId="emptyStringValidator" />
	      </wi:inputTextarea>
	    </div>
	    <div>
	      <a:commandButton
	        id="excluirRestaurarDocButton"
	        actionListener="#{documentoProcessoAction.exclusaoRestauracaoDocumento()}"
	        limitRender="true"
	        execute="@form"
	        rendered="#{empty hiddenIdDocumento}"
	        onclick="infox.showLoading();"
	        oncomplete="infox.hideLoading(); if(#{not facesContext.validationFailed}){#{rich:component('requestMotivoPanel')}.hide();}else{atualizarOnValidationFailed();}"
	        value="Enviar"
	        render="@form, documentoList, pageBodyDialogMessage"
	        styleClass="buttons" />
	    </div>
	  </h:form>
	</rich:popupPanel>
        
     <s:div
       id="historicoDocumentoPanelDiv"
       style="margin-top:20px; width:100%;">
       <rich:panel
         id="historicoDocumentoPanel"
         headerClass=""
         rendered="#{not empty documentoProcessoAction.processoDocumentoSelected}"
         bodyClass="dtable-p-b"
         styleClass="dtable-p"
         style="width:100%;">

         <f:facet name="header">
           <h:outputText
             value="#{infoxMessages['historicoStatusDocumento.tableTile']}" />
           <h:graphicImage
             value="#{wiSkin.imageFolder}/closeMP.gif"
             onmouseup="selectDocumento(0);"
             style="float:right;" />
         </f:facet>

         <rich:dataTable
           id="historicoDocumentoDataTable"
           var="historicoDocumento"
           style="width:100%"
           value="#{documentoProcessoAction.listHistoricoStatusDocumento}">

           <rich:column style="text-align:center;">
             <f:facet name="header">#{infoxMessages['historicoStatusDocumento.nomeUsuarioAlterou']}</f:facet>
             <h:outputText
               value="#{historicoDocumento.usuarioAlteracao.nomeUsuario}" />
           </rich:column>

           <rich:column style="text-align:center;">
             <f:facet name="header">#{infoxMessages['historicoStatusDocumento.dataAlteracao']}</f:facet>
             <h:outputText
               value="#{historicoDocumento.dataAlteracao}">
               <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
             </h:outputText>
           </rich:column>

           <rich:column style="text-align:center;">
             <f:facet name="header">Tipo Operação</f:facet>
             <h:outputText
               value="#{historicoDocumento.tipoAlteracaoDocumento.label}" />
           </rich:column>

           <rich:column>
             <f:facet name="header">#{infoxMessages['historicoStatusDocumento.motivo']}</f:facet>
             <h:outputText value="#{historicoDocumento.motivo}" />
           </rich:column>

         </rich:dataTable>
       </rich:panel>
     </s:div>
    <wi:assinaturaPopup id="assinaturaDocumentoPopup" afterRender="documentoList" />
</ui:composition>