<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:s="http://jboss.org/schema/seam/taglib"
    xmlns:wi="http://www.itx.com.br/jsf"
    xmlns:infox="http://www.infox.com.br/jsf"
    template="/WEB-INF/xhtml/templates/minimal.xhtml">
    <ui:param
        name="pageTitle"
        value="#{infoxMessages['processo.titlePage']}" />
    <ui:define name="title">#{pageTitle}</ui:define>
    <ui:define name="contentTitle">
    </ui:define>
    <ui:define name="scripts">
        <h:outputScript
            library="js/components"
            name="Modal.js" />
        <h:inputHidden
            id="taskCompleted"
            value="#{taskInstanceHome.taskCompleted}"></h:inputHidden>
        <h:inputHidden
            id="canClosePanel"
            value="#{taskInstanceHome.canClosePanelVal}"></h:inputHidden>
        <h:outputScript>
      function verifyFields() {
        try {
            opener.atualizaPainelFluxo();
          } catch (e) {
          }
        if ($('#taskCompleted').val() === 'true') {
          try {
            opener.atualizaPainelFluxo();
          } catch (e) {
          }
          if ($('#canClosePanel').val() === 'true') {
            close();
          } else {
            location = location.href.replace(/&amp;tarefaId=\d+/g,"");
          }
        } else {
          infox.hideLoading();
        }
      }
    </h:outputScript>
        <h:outputScript>
      function reloadPanel() {
          try {
            opener.atualizaPainelFluxo();
          } catch (e) {
          }
      }
    </h:outputScript>
    <h:outputScript rendered="#{processoEpaHome.tab=='tabSaida'}">
      invoke([ "infox.Modal" ], function(Modal) {
        var panelTeste = new Modal({
          id : "#{rich:clientId('mp_taskNodeDescription')}"
        });
        $(".mp-help").click(function show() {
          panelTeste.show();
        });

        #{rich:jQuery('mp_taskNodeCloseBtn')}.click(function hide() {
          panelTeste.hide();
        });
      });
    </h:outputScript>
    </ui:define>
    <ui:param
        name="home"
        value="#{processoEpaHome}" />
    <ui:param
        name="showMenu"
        value="false" />
    <ui:param
        name="checkPermission"
        value="#{processoEpaHome.checarVisibilidadeSemException()}" />
    <ui:param
        name="isUsuarioExterno"
        value="#{authenticator.usuarioExterno ? 'true':'false'}" />
    <ui:param
        name="showMsg"
        value="#{!isUsuarioExterno}" />
    <ui:param
        name="panelStyleClass"
        value="rf-dt-crud" />
    <ui:define name="body">
        <rich:collapsiblePanel
            switchType="client"
            header="#{infoxMessages['processo.titleView']} #{processoEpaHome.instance.numeroProcesso} - #{taskInstance.processInstance.processDefinition.name} - #{taskInstance.name} "
            expanded="false">
            <h:panelGrid columns="4"  width="100%"  columnClasses="viewColumn">
            
            	 <wi:outputText
                    id="dataInicio"
                    label="#{infoxMessages['processo.dataInicio']}"
                    value="#{processoEpaHome.instance.dataInicio}">
                    <f:convertDateTime pattern="dd/MM/yyyy kk:mm" />
                </wi:outputText>
                
                <wi:outputText
                    id="usuarioCadastro"
                    label="#{infoxMessages['processo.usuarioCadastroProcesso']}"
                    value="#{processoEpaHome.instance.usuarioCadastro}" />
            
            	<ui:repeat var="metadado" value="#{processoEpaHome.detalhesMetadados}" >
            		<wi:outputText id="metadado#{metadado.metadadoType}"
                    label="#{metadadoMessages[metadado.metadadoType]}"
                    value="#{metadado}" />
            	</ui:repeat>
            	
            </h:panelGrid>
        </rich:collapsiblePanel>
        <h:form>
            <a:jsFunction
                name="renderButtons"
                render="taskButtonsDiv" />
        </h:form>
        <infox:tabPanel
            switchType="ajax"
            rendered="#{checkPermission}"
            activeTab="#{home.tab}"
            id="movimentarTabPanel">
            <h:form rendered="#{!isUsuarioExterno}">
                <infox:tabHeaders />
            </h:form>
            <infox:tab
                id="tabVariaveisProcesso"
                name="tabVariaveisProcesso"
                rendered="#{variavelProcessoAction.possuiVariaveis()}"
                title="#{infoxMessages['variavelProcesso.variaveisProcesso']}">
                <h:form>
                    <rich:panel>
                        <ui:repeat
                            var="variavel"
                            value="#{variavelProcessoAction.variaveis}">
                            <wi:inputText
                                id="variavel-#{variavel.nome.replace(':', '_')}"
                                label="#{variavel.label}"
                                value="#{variavel.valor}" />
                        </ui:repeat>
                    </rich:panel>
                    <wi:commandButton
                        id="btnGravarVariaveis"
                        value="Gravar"
                        action="#{variavelProcessoAction.save()}"
                        reRender="@form, pageBodyDialogMessage" />
                </h:form>
            </infox:tab>
            <infox:tab
                id="tabEntrada"
                name="tabEntrada"
                rendered="#{!empty taskInstanceView.fields}"
                status=":status"
                title="#{infoxMessages['movimentar.entrada.titleTab']}">
                <wi:form
                    canEdit="true"
                    formTitle="#{taskInstance.name}"
                    home="#{taskInstanceHome}"
                    form="#{taskInstanceView}" />
            </infox:tab>
            <infox:tab
                id="tabSaida"
                name="tabSaida"
                rendered="#{processoEpaHome.managed}"
                status=":status"
                title="#{infoxMessages['movimentar.saida.titleTab']}">
                <c:if test="#{not taskPageAction.hasTaskPage}">
                    <wi:form
                        canEdit="true"
                        formTitle="#{taskInstance.name}"
                        home="#{taskInstanceForm.home}"
                        reRenderSave="taskInstanceForm"
                        form="#{taskInstaceForm}" />
                </c:if>
                <c:if test="#{taskPageAction.hasTaskPage}">
                    <ui:include src="#{taskPageAction.taskPagePath}" />
                </c:if>
            </infox:tab>
            <infox:tab
                id="tabAnexar"
                name="tabAnexar"
                rendered="#{processoEpaHome.managed}"
                status=":status"
                title="#{infoxMessages['movimentar.anexar.titleTab']}"
                action="#{anexoController.onClickTabAnexar(processoEpaHome.instance)}">
                <wi:dataForm
                    formId="anexarDocumentosForm"
                    formTitle="#{infoxMessages['movimentar.anexar.titleForm']}"
                    isUploadForm="true">
                    <ui:include src="anexarDocumentos.xhtml" />
                    <ui:define name="buttons" />
                </wi:dataForm>
            </infox:tab>
            <infox:tab
                id="tabAnexos"
                name="tabAnexos"
                rendered="#{processoEpaHome.managed}"
                status=":status"
                action="#{documentoList.entity.setProcesso(processoEpaHome.instance)}"
                actionListener="#{documentoProcessoAction.onClickDocumentosTab()}"
                title="#{infoxMessages['movimentar.documentos.titleTab']}">
                <ui:include src="pastaDocumento.xhtml" />
            </infox:tab>

            <infox:tab
                id="tabMovimentacoes"
                name="tabMovimentacoes"
                rendered="#{processoEpaHome.managed}"
                status=":status"
                title="#{infoxMessages['movimentar.movimentacoes.titleTab']}">
                <ui:include
                    src="/WEB-INF/xhtml/components/grid/movimentacoesProcessoGrid.xhtml" />
            </infox:tab>
            <ui:param
                name="action"
                value="#{localizacaoDocumentoFisicoCrudAction}" />
            <infox:tab
                id="documentoFisicoTab"
                name="documentoFisicoTab"
                rendered="#{home.isManaged()}"
                action="#{localizacaoDocumentoFisicoCrudAction.setProcesso(processoEpaHome.instance)}"
                title="#{infoxMessages['documentoFisico.titleTab']}">
                <wi:dataForm
                    formId="documentoFisicoForm"
                    formTitle="#{infoxMessages['documentoFisico.form']}">
                    <wi:tree
                        id="localizacaoFisica"
                        assignTo="localizacaoDocumentoFisicoCrudAction.instance.localizacaoFisica"
                        tree="#{localizacaoFisicaTree}"
                        label="#{infoxMessages['documentoFisico.localizacaoFisica']}"
                        required="true"
                        noSelectionLabel="#{infoxMessages['documentoFisico.selectLocalizacaoFisica']}" />
                    <wi:inputText
                        id="descricaoDocumentoFisico"
                        label="#{infoxMessages['documentoFisico.descricaoDocumentoFisico']}"
                        required="true"
                        value="#{action.instance.descricaoDocumentoFisico}"
                        maxlength="150" />
                    <ui:define name="buttons">
                        <wi:commandButton
                            id="saveDocumentoFisicoButton"
                            action="localizacaoDocumentoFisicoCrudAction.save"
                            reRender="documentoFisicoForm, documentoFisicoDiv, pageBodyDialogMessage"
                            value="#{infoxMessages['crud.persist']}" />
                    </ui:define>
                </wi:dataForm>
                <s:div id="documentoFisicoDiv">
                    <wi:dataTable
                        id="documentoFisicoTable2"
                        values="#{localizacaoDocumentoFisicoCrudAction.documentoFisicoList}"
                        var="row"
                        rows="10"
                        showSearchForm="false"
                        panelStyleCss="full-sized">
                        <ui:define name="toolBar">
                            <wi:toolBarRemove
                                id="toolBarInactivate"
                                reRender="documentoFisicoDiv, pageBodyDialogMessage"
                                actionRemove="localizacaoDocumentoFisicoCrudAction.remove(row)" />
                        </ui:define>
                        <ui:define name="headerToolBar" />
                        <wi:columnOutputText
                            columnId="localizacaoFisica"
                            columnHeader="#{infoxMessages['documentoFisico.localizacaoFisica']}"
                            value="#{row.localizacaoFisica.caminhoCompletoToString()}"
                            hideOrder="true" />
                        <wi:columnOutputText
                            columnId="descricao"
                            columnHeader="#{infoxMessages['documentoFisico.descricaoDocumentoFisico']}"
                            value="#{row.descricaoDocumentoFisico}"
                            hideOrder="true" />
                    </wi:dataTable>
                </s:div>
            </infox:tab>
            <infox:tab
                id="relacionamentoProcessoTab"
                name="relacionamentoProcessoTab"
                rendered="#{home.isManaged()}"
                title="#{infoxMessages['relacionamentoProcesso.titleTab']}">
                <s:div id="relacionamentoProcessoFormDiv">
                    <wi:dataForm
                        formId="relacionamentoProcessoForm"
                        formTitle="#{infoxMessages['relacionamentoProcesso.titleForm']}"
                        home="#{relacionamentoCrudAction}">
                        <wi:inputText
                            id="labelNumeroProcesso"
                            label="#{infoxMessages['relacionamentoProcesso.numeroProcesso']}"
                            required="true"
                            maxlength="30"
                            value="#{relacionamentoCrudAction.processoRelacionado}"
                            disabled="#{relacionamentoCrudAction.managed}">
                        </wi:inputText>
                        <wi:selectOneMenuEntity
                            id="tipoRelacionamento"
                            value="#{relacionamentoCrudAction.instance.tipoRelacionamentoProcesso}"
                            label="#{infoxMessages['tipoRelacionamentoProcesso.tipoRelacionamento']}"
                            items="#{relacionamentoCrudAction.tipoRelacionamentoProcessoList}"
                            required="true"
                            hideNoSelectionLabel="false"
                            showLabelSelecione="true">
                        </wi:selectOneMenuEntity>
                        <wi:inputTextarea
                            id="motivo"
                            label="#{infoxMessages['relacionamentoProcesso.motivo']}"
                            value="#{relacionamentoCrudAction.instance.motivo}"
                            required="true">
                        </wi:inputTextarea>
                        <wi:selectSituacaoRadio
                            id="ativo"
                            label="#{infoxMessages['field.situacao']}"
                            rendered="#{relacionamentoCrudAction.managed}"
                            value="#{relacionamentoCrudAction.instance.ativo}" />
                        <ui:define name="buttons">
                            <wi:commandButton
                                id="persistButton"
                                action="relacionamentoCrudAction.save()"
                                reRender="relacionamentoProcessoFormDiv relacionamentoProcessoDTDiv pageBodyDialogMessage"
                                value="#{relacionamentoCrudAction.isManaged() ? messages['crud.update'] : messages['crud.persist']}"
                                execute="relacionamentoProcessoFormDiv">
                            </wi:commandButton>
                            <wi:commandButtonNew newInstanceAction="relacionamentoCrudAction.newInstance()"
                            					 reRender="relacionamentoProcessoFormDiv"/>
                        </ui:define>
                    </wi:dataForm>
                </s:div>
                <s:div id="relacionamentoProcessoDTDiv" style="margin-top:10px">
                    <h:panelGroup
                        id="dtable"
                        rendered="#{not empty relacionamentoCrudAction.processo}">
                        <wi:dataTable
                            id="relProcDt2"
                            bean="#{relacionamentoProcessoList}"
                            values="#{relacionamentoProcessoList.list(15)}"
                            tableTitle="#{infoxMessages['relacionamentoProcesso.processosRelacionados']}"
                            rowId="#{row.idRelacionamentoProcesso}"
                            showSearchForm="false"
                            panelStyleClass="rel-proc-dt">
                            <ui:define name="headerToolBar" />
                            <ui:define name="toolBar">
                                <wi:toolBarEdit
                                    id="#{id}Edit"
                                    action="#{relacionamentoCrudAction.setEditMode(row.numeroProcesso, row.relacionamento.idRelacionamento)}"
                                    render="relacionamentoProcessoFormDiv pageBodyDialogMessage" />
                                <wi:toolBar
                                    id="#{id}Inactivate"
                                    action="relacionamentoCrudAction.inactive(row.relacionamento)"
                                    rendered="#{row.relacionamento.ativo}"
                                    limitToList="true"
                                    status=":status"
                                    render="relacionamentoProcessoFormDiv relacionamentoProcessoDTDiv pageBodyDialogMessage"
                                    onclick="return confirm(\'#{infoxMessages['crud.confirmInactivate']}\');"
                                    url="#{wiSkin.imageFolder}/remove.png"
                                    title="#{infoxMessages['button.inactive']}" />
                            </ui:define>
                            <wi:columnOutputText
                                columnId="numeroProcesso"
                                columnHeader="#{infoxMessages['relacionamentoProcesso.numeroProcesso']}"
                                value="#{row.numeroProcesso}" />
                            <wi:columnOutputText
                                columnId="motivo"
                                columnHeader="#{infoxMessages['relacionamentoProcesso.motivo']}"
                                value="#{row.relacionamento.motivo}" />
                            <wi:columnOutputText
                                columnId="nomeUsuario"
                                columnHeader="#{infoxMessages['relacionamentoProcesso.nomeUsuario']}"
                                value="#{row.relacionamento.nomeUsuario}" />
                            <wi:columnOutputText
                                columnId="dataRelacionamento"
                                columnHeader="#{infoxMessages['relacionamentoProcesso.dataRelacionamento']}"
                                value="#{row.relacionamento.dataRelacionamento}" />
                            <wi:columnOutputText
                                columnId="ativo"
                                value="#{row.relacionamento.ativo ? messages['entity.ativo'] : messages['entity.inativo']}"
                                columnHeader="#{infoxMessages['entity.situacao']}"
                                columnStyle="text-align:center;"
                                columnWidth="10%" />
                        </wi:dataTable>
                    </h:panelGroup>
                </s:div>
            </infox:tab>
            <infox:tab
                id="tabPartesDoProcesso"
                name="tabPartesDoProcesso"
                status=":status"
                action="#{participantesProcessoController.setProcesso(home.instance)}"
                rendered="#{home.hasPartes()}"
                title="#{infoxMessages['participanteProcesso.participantes']}">
                <ui:include src="parteProcessoGrid.xhtml" />
            </infox:tab>
            <infox:tab
                id="tabComunicacao"
                name="tabComunicacao"
                status=":status"
                rendered="#{s:hasPermission('abaComunicacao', 'access')}"
                title="Comunicação"
                action="#{comunicacaoAction.clear}">
                <ui:include src="comunicacao.xhtml" />
            </infox:tab>
            <ui:include src="abasCustomizadasDoMovimentar.xhtml" />
        </infox:tabPanel>
        <c:if test="#{!checkPermission}">
            <wi:outputText
                id="error"
                value="#{infoxMessages['movimentar.noPermission']}" />
        </c:if>
        <ui:param
            name="modalWidth"
            value="640" />
        <ui:param
            name="modalHeight"
            value="480" />
        <rich:popupPanel
            id="mp_taskNodeDescription"
            height="#{modalHeight}"
            width="#{modalWidth}"
            show="false"
            modal="true"
            moveable="true"
            resizeable="false"
            styleClass="popup-help"
            domElementAttachment="parent">
            <f:facet name="header">
                <h:outputText
                    value="#{infoxMessages['jbpm.taskNode.description']}" />
            </f:facet>
            <f:facet name="controls">
                <h:panelGroup>
                    <h:graphicImage
                        id="mp_taskNodeCloseBtn"
                        styleClass="mp-close"
                        value="#{wiSkin.imageFolder}/closeMP.gif" />
                </h:panelGroup>
            </f:facet>
            <wi:editor
                id="taskNodeDescription"
                value="#{taskInstanceHome.taskNodeDescription}"
                width="#{modalWidth-15}"
                height="#{modalHeight-90}"
                readonly="true" />
        </rich:popupPanel>
        <wi:assinaturaPopup id="assinaturaDocumentoPopup" afterRender="documentoList" />
    </ui:define>
</ui:composition>
