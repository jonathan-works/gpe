<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:s="http://jboss.org/schema/seam/taglib"
    xmlns:wi="http://www.itx.com.br/jsf"
    xmlns:infox="http://www.infox.com.br/jsf"
    template="/WEB-INF/xhtml/templates/minimal.xhtml">

    <ui:param name="pageTitle" value="#{messages['processo.titlePage']}" />
    <ui:define name="title">#{pageTitle}</ui:define>
    <ui:define name="contentTitle">
    	#{pageTitle}
    </ui:define>
    <ui:define name="scripts">
    	<h:outputScript library="js/components" name="Modal.js" />
    	<h:inputHidden id="taskCompleted" value="#{taskInstanceHome.taskCompleted}"></h:inputHidden>
        <h:inputHidden id="canClosePanel" value="#{taskInstanceHome.canClosePanelVal}"></h:inputHidden>
            <script type="text/javascript">
                function verifyFields() {
                    if ($('#taskCompleted').val() != '') {
                        try {
                            opener.atualizaPainelFluxo();
                        } catch (e) {
                        }
                        if ($('#canClosePanel').val() != '') {
                            close();
                        } else {
                            location = location.href;
                        }
                    } else {
                        infox.hideLoading();
                    }
                }
            </script>
    </ui:define>

    <ui:param name="home" value="#{processoHome}" />
    <ui:param name="showMenu" value="false" />
    <ui:param name="checkPermission"
        value="#{processoHome.checarVisibilidade()}" />
    <ui:param name="isUsuarioExterno"
        value="#{authenticator.usuarioExterno ? 'true':'false'}" />
    <ui:param name="showMsg" value="#{!isUsuarioExterno}" />
    <ui:define name="head">
        <h:outputStylesheet library="styleSkinInfox"
            name="movimentar.css" />
    </ui:define>
    <ui:define name="body">

        <h:form>

            <a:jsFunction name="renderButtons" render="taskButtonsDiv" />

        </h:form>

        <infox:tabPanel switchType="ajax" rendered="#{checkPermission}"
            activeTab="#{home.tab}" id="movimentarTabPanel">
            <h:form rendered="#{!isUsuarioExterno}">
                <infox:tabHeaders />
            </h:form>

            <infox:tab id="tabFluxo" name="tabFluxo"
                rendered="#{!processoHome.managed}" status=":status"
                title="Escolher fluxo" action="#{processoHome.limpar()}">

            </infox:tab>

            <infox:tab id="tabVariaveisProcesso"
                name="tabVariaveisProcesso"
                rendered="#{variavelProcessoAction.possuiVariaveis()}"
                title="#{messages['variavelProcesso.variaveisProcesso']}">

                <h:form>

                    <rich:panel>

                        <ui:repeat var="variavel"
                            value="#{variavelProcessoAction.variaveis}">

                            <wi:inputText
                                id="variavel-#{variavel.nome.replace(':', '_')}"
                                label="#{variavel.label}"
                                value="#{variavel.valor}" />

                        </ui:repeat>

                    </rich:panel>

                    <a:commandButton value="Gravar"
                        action="#{variavelProcessoAction.save}"
                        render="@form, pageBodyDialogMessage" />

                </h:form>

            </infox:tab>

            <infox:tab id="tabEntrada" name="tabEntrada"
                rendered="#{!empty taskInstanceView.fields}"
                status=":status" title="Entrada">

                <wi:form canEdit="true" formTitle="#{taskInstance.name}"
                    home="#{taskInstanceHome}"
                    form="#{taskInstanceView}" />


            </infox:tab>

            <infox:tab id="tabSaida" name="tabSaida"
                rendered="#{processoHome.managed}" status=":status"
                title="SaÃ­da">
                
                <h:graphicImage id="helpBtn" styleClass="mp-help" value="#{a4jSkin.imgIconHelp}" />
                
                <script>
	                invoke(["infox.Modal"],function(Modal) {
	                    var panelTeste = new Modal({id:'mp_taskNodeDescription'});
	                    $("#movimentarTabPanel\\:helpBtn").click(function show() {
	                        panelTeste.show();
	                    });
	                    $("#mp_taskNodeCloseBtn").click(function hide() {
	                        panelTeste.hide();
	                    });
	                });
                </script>
                
                <c:if test="#{not taskPageAction.hasTaskPage}">
                    <wi:form canEdit="true"
                        formTitle="#{taskInstance.name}"
                        home="#{taskInstanceForm.home}"
                        reRenderSave="taskInstanceForm"
                        form="#{taskInstaceForm}" />

                </c:if>
                <c:if test="#{taskPageAction.hasTaskPage}">

                    <ui:include src="#{taskPageAction.taskPagePath}" />

                </c:if>

            </infox:tab>

            <infox:tab id="tabAnexar" name="tabAnexar"
                rendered="#{processoHome.managed}" status=":status"
                title="#{messages['processoDocumento.anexarDocumento']}"
                action="#{anexoController.onClickTabAnexar(processoHome.instance)}">
                <wi:dataForm formId="anexarDocumentosForm"
                    formTitle="#{messages['form.title']}"
                    isUploadForm="true">
                    <ui:include
                        src="anexarDocumentos.xhtml" />
                    <ui:define name="buttons" />
                </wi:dataForm>


            </infox:tab>

            <infox:tab id="tabAnexos" name="tabAnexos"
                rendered="#{processoHome.managed}" status=":status"
                action="#{processoDocumentoList.entity.setProcesso(processoHome.instance)}"
                title="Documentos do Processo">
                <wi:dataTable values="#{processoDocumentoList.list(15)}"
                    bean="#{processoDocumentoList}"
                    tableTitle="#{messages['processo.documentos']} #{home.instance}"
                    id="processoDocumentoList"
                    rowId="#{row.idProcessoDocumento}"
                    searchFormStyleClass="hidden">

                    <ui:define name="headerToolBar" />
                    <wi:columnOutputText columnId="usuarioInclusao"
                        columnHeader="#{messages['processoDocumento.usuarioInclusao']}"
                        value="#{row.usuarioInclusao}" />
                    <wi:columnDateTime columnId="dataInclusao"
                        columnHeader="#{messages['processoDocumento.dataInclusao']}"
                        value="#{row.dataInclusao}" />
                    <wi:columnOutputText columnId="processoDocumento"
                        columnHeader="#{messages['processoDocumentoBin.documento']}"
                        value="#{row.processoDocumento}" />
                    <ui:define name="toolBar">
                        <s:link target="idJan#{row.idProcessoDocumento}"
                            rendered="#{not empty row.processoDocumentoBin.signature and not empty row.processoDocumentoBin.certChain}"
                            view="/Processo/Consulta/validaDocumento.xhtml"
                            onclick="infox.abrirPopUp('idJan#{row.idProcessoDocumento}');">
                            <h:graphicImage
                                title="#{messages['assinaturas.validar']}"
                                alt="#{messages['assinaturas.validar']}"
                                url="/img/lock.png" />
                            <f:param value="#{row.idProcessoDocumento}"
                                name="idProcessoDocumento" />
                        </s:link>

                        <s:link target="idJan#{row.idProcessoDocumento}"
                            rendered="#{empty row.processoDocumentoBin.signature or empty row.processoDocumentoBin.certChain}"
                            view="/Processo/Consulta/assinaDocumento.xhtml"
                            onclick="infox.abrirPopUp('idJan#{row.idProcessoDocumento}');">
                            <h:graphicImage
                                title="#{messages['assinaturas.assinar']}"
                                alt="#{messages['assinaturas.assinar']}"
                                url="/img/lock_unlock.png" />
                            <f:param value="#{row.idProcessoDocumento}"
                                name="idProcessoDocumento" />

                        </s:link>
                    </ui:define>

                </wi:dataTable>

            </infox:tab>

            <infox:tab id="tabMovimentacoes" name="tabMovimentacoes"
                rendered="#{processoHome.managed}" status=":status"
                title="#{messages['movimentar.movimentacoesProcesso']}">
                <ui:include
                    src="/WEB-INF/xhtml/components/grid/movimentacoesProcessoGrid.xhtml" />

            </infox:tab>

            <ui:param name="action"
                value="#{localizacaoDocumentoFisicoCrudAction}" />
            <infox:tab id="documentoFisicoTab" name="documentoFisicoTab"
                rendered="#{home.isManaged()}"
                action="#{localizacaoDocumentoFisicoCrudAction.setProcesso(processoHome.instance)}"
                title="#{messages['documentoFisico.titleTab']}">
                <wi:dataForm formId="documentoFisicoForm"
                    formTitle="#{messages['form.title']}">

                    <wi:tree id="localizacaoFisica"
                        assignTo="localizacaoDocumentoFisicoCrudAction.instance.localizacaoFisica"
                        tree="#{localizacaoFisicaTree}"
                        label="#{messages['documentoFisico.localizacaoFisica']}"
                        required="true"
                        noSelectionLabel="#{messages['documentoFisico.selectLocalizacaoFisica']}" />

                    <wi:inputText id="descricaoDocumentoFisico"
                        label="#{messages['documentoFisico.descricaoDocumentoFisico']}"
                        required="true"
                        value="#{action.instance.descricaoDocumentoFisico}"
                        maxlength="150" />
                    <ui:define name="buttons">

                        <wi:commandButton id="saveDocumentoFisicoButton"
                            action="localizacaoDocumentoFisicoCrudAction.save"
                            reRender="documentoFisicoForm, documentoFisicoDiv, pageBodyDialogMessage"
                            value="#{messages['crud.persist']}" />

                    </ui:define>

                </wi:dataForm>
                <s:div id="documentoFisicoDiv">
                    <wi:dataTable id="documentoFisicoTable2"
                        values="#{localizacaoDocumentoFisicoCrudAction.documentoFisicoList}"
                        var="row" rows="10"
                        searchFormStyleClass="hidden">
                        <ui:define name="toolBar">
                            <wi:toolBarInactive id="toolBarInactivate"
                                reRender="documentoFisicoDiv, pageBodyDialogMessage"
                                actionInactive="localizacaoDocumentoFisicoCrudAction.inactive(row)" />
                        </ui:define>
                        <ui:define name="headerToolBar" />
                        <wi:columnOutputText
                            columnId="localizacaoFisica"
                            columnHeader="#{messages['documentoFisico.localizacaoFisica']}"
                            value="#{row.localizacaoFisica.caminhoCompletoToString()}"
                            hideOrder="true" />
                        <wi:columnOutputText columnId="descricao"
                            columnHeader="#{messages['documentoFisico.descricaoDocumentoFisico']}"
                            value="#{row.descricaoDocumentoFisico}"
                            hideOrder="true" />
                    </wi:dataTable>
                </s:div>

            </infox:tab>
            <infox:tab
                id="relacionamentoProcessoTab"
                name="relacionamentoProcessoTab"
                rendered="#{home.isManaged()}"
                title="#{messages['relacionamentoProcesso.titleTab']}"
            >
                <s:div id="relacionamentoProcessoFormDiv">
                    <wi:dataForm
                        formId="relacionamentoProcessoForm"
                        formTitle="#{messages['form.title']}"
                        home="#{relacionamentoProcessoCrudAction}"
                    >
                        <wi:inputText
                            id="labelNumeroProcesso"
                            label="#{messages['relacionamentoProcesso.numeroProcesso']}"
                            required="true"
                            maxlength="30"
                            value="#{relacionamentoProcessoCrudAction.instance.numeroProcesso}"
                            disabled="#{relacionamentoProcessoCrudAction.managed}"
                        >
                        </wi:inputText>
                        <wi:selectOneMenuEntity
                            id="tipoRelacionamento"
                            value="#{relacionamentoProcessoCrudAction.instance.tipoRelacionamentoProcesso}"
                            label="#{messages['tipoRelacionamentoProcesso.tipoRelacionamento']}"
                            items="#{relacionamentoProcessoCrudAction.tipoRelacionamentoProcessoList}"
                            required="true"
                            hideNoSelectionLabel="false"
                            noSelectionLabel="Selecione..."
                        >
                        </wi:selectOneMenuEntity>
                        <wi:inputText
                            id="motivo"
                            label="#{messages['relacionamentoProcesso.motivo']}"
                            value="#{relacionamentoProcessoCrudAction.instance.motivo}"
                            required="true"
                        >
                        </wi:inputText>
                        <wi:selectSituacaoRadio
                            id="ativo"
			                label="#{messages['field.situacao']}"
			                rendered="#{relacionamentoProcessoCrudAction.managed}"
			                value="#{relacionamentoProcessoCrudAction.instance.ativo}" />
                        <ui:define name="buttons">
                           <wi:commandButton
                               id="persistButton"
                               action="relacionamentoProcessoCrudAction.save()"
                               reRender="relacionamentoProcessoFormDiv relacionamentoProcessoDTDiv pageBodyDialogMessage"
                               value="#{relacionamentoProcessoCrudAction.isManaged() ? messages['crud.update'] : messages['crud.persist']}"
                               execute="relacionamentoProcessoFormDiv"
                           >
                           </wi:commandButton>
                        </ui:define>
                    </wi:dataForm>
                </s:div>
                <s:div id="relacionamentoProcessoDTDiv">
                    <h:panelGroup id="dtable" rendered="#{not empty relacionamentoProcessoCrudAction.instance.relacionamento}">
	                    <wi:dataTable
	                        id="relProcDt2"
	                        bean="#{relacionamentoProcessoList}"
	                        values="#{relacionamentoProcessoList.list(15)}"
	                        tableTitle="#{messages['relacionamentoProcesso.processosRelacionados']}"
	                        rowId="#{row.idRelacionamentoProcesso}"
	                        searchFormStyleClass="hidden"
	                        panelStyleClass="rel-proc-dt"
	                    >
	                        <ui:define name="headerToolBar" />
	                        <ui:define name="toolBar">
	                            <wi:toolBarEdit
	                                id="#{id}Edit"
	                                action="#{relacionamentoProcessoCrudAction.setId(row.idRelacionamentoProcesso)}"
	                                render="relacionamentoProcessoFormDiv pageBodyDialogMessage"
	                            />
	                            <wi:toolBarInactive
	                                id="#{id}Inactivate"
	                                actionInactive="relacionamentoProcessoCrudAction.inactive(row)"
	                                reRender="relacionamentoProcessoFormDiv relacionamentoProcessoDTDiv pageBodyDialogMessage"
	                            />
	                        </ui:define>
	                        
	                        <wi:columnOutputText
	                           columnId="numeroProcesso"
	                           columnHeader="#{messages['relacionamentoProcesso.numeroProcesso']}"
	                           value="#{row.numeroProcesso}"
	                        />
	                        <wi:columnOutputText
	                           columnId="motivo"
	                           columnHeader="#{messages['relacionamentoProcesso.motivo']}"
	                           value="#{row.motivo}"
	                        />
	                        <wi:columnOutputText
	                           columnId="nomeUsuario"
	                           columnHeader="#{messages['relacionamentoProcesso.nomeUsuario']}"
	                           value="#{row.nomeUsuario}"
	                        />
	                        <wi:columnOutputText
	                           columnId="dataRelacionamento"
	                           columnHeader="#{messages['relacionamentoProcesso.dataRelacionamento']}"
	                           value="#{row.dataRelacionamento}"
	                        />
	                        <wi:columnSituacao
	                           columnId="ativo"
	                           columnHeader="#{messages['field.ativo']}"
	                        >
	                        </wi:columnSituacao>
	                    </wi:dataTable>
                    </h:panelGroup>
                </s:div>
            </infox:tab>

            <infox:tab id="tabPartesDoProcesso"
                name="tabPartesDoProcesso" status=":status"
                action="#{partesProcessoController.setProcessoEpa(home.instance)}"
                rendered="#{home.hasPartes()}"
                title="#{messages['parteProcesso.partes']}">
                <ui:include src="parteProcessoGrid.xhtml" />

            </infox:tab>

        </infox:tabPanel>

        <c:if test="#{!checkPermission}">

            <wi:outputText id="error"
                value="#{messages['movimentar.noPermission']}" />

        </c:if>
        <ui:param name="modalWidth" value="640" />
        <ui:param name="modalHeight" value="480" />
        <rich:popupPanel
        	id="mp_taskNodeDescription"
        	height="#{modalHeight}"
        	width="#{modalWidth}"
        	show="false"
        	modal="true"
        	moveable="true"
        	resizeable="false"
        	styleClass="popup-help"
        	domElementAttachment="parent"
        >
			<f:facet name="header">
				<h:outputText value="#{messages['jbpm.taskNode.description']}" />
			</f:facet>
			<f:facet name="controls">
				<h:panelGroup>
					<h:graphicImage
						id="mp_taskNodeCloseBtn"
						styleClass="mp-close" 
						value="/img/closeMP.gif"/>
				</h:panelGroup>
			</f:facet>
			<wi:editor
				id="taskNodeDescription"
				value="#{taskInstanceHome.taskNodeDescription}"
				width="#{modalWidth-15}"
				height="#{modalHeight-90}"
				readonly="true"
			></wi:editor>			
		</rich:popupPanel>

    </ui:define>

</ui:composition>
