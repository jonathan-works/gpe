<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.org/schema/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:wi="http://www.itx.com.br/jsf"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich">

	<wi:commandButton id="criarComunicacao" value="#{infoxMessages['comunicacao.criarComunicacao']}"
		onclick="infox.openPopUp('_blank', '#{pathResolver.contextPath}/Processo/criarComunicacao.seam?jbpmProcessId=#{comunicacaoAction.jbpmProcessId}','1024'); hideLoading(); return false;" 
		rendered="#{s:hasRole(usuarioInterno)}" />
	<h:form>
		<a:jsFunction name="reloadAll" render="comunicacoesDiv" limitRender="true" execute="@this" 
			action="#{comunicacaoAction.clearCacheModelos}"/>
	</h:form>
	<s:div id="comunicacoesDiv">
		<rich:collapsiblePanel switchType="client" id="rascunhos" header="#{infoxMessages['comunicacao.rascunhos']}" rendered="#{s:hasRole(usuarioInterno)}">
			<wi:dataTable id="rascunhosTable" bean="#{modeloComunicacaoRascunhoList}" showSearchForm="false"
				values="#{modeloComunicacaoRascunhoList.list(5)}" rowId="#{row.id}" hideOrder="true">
				<ui:define name="headerToolBar" />
				<ui:define name="toolBar">
					<h:form>
						<a:commandLink execute="@this"
							onclick="infox.openPopUp('comunicacao#{row.id}', '#{pathResolver.contextPath}/Processo/criarComunicacao.seam?idModeloComunicacao=#{row.id}','1024'); return false;">
							<h:graphicImage url="#{wiSkin.imageFolder}/view.png" title="#{infoxMessages['button.selecionar']}" />
						</a:commandLink>
					</h:form>
				</ui:define>
				<wi:columnOutputText columnHeader="#{infoxMessages['comunicacao.tipoComunicacao']}" value="#{row.tipoComunicacao.descricao}"/>
			</wi:dataTable>
		</rich:collapsiblePanel>
		<br />
		<rich:collapsiblePanel header="#{infoxMessages['comunicacao.comunicacoes']}" 
			switchType="client" id="comunicacoes" rendered="#{not empty comunicacaoAction.comunicacoesDoProcesso}">
			<h:form>
				<rich:dataTable value="#{comunicacaoAction.getDestinatarios()}" 
					var="bean" styleClass="dtable rf-dt-crud">
					<rich:column styleClass="dt-toolbar-col" rendered="#{s:hasRole(usuarioInterno)}">
							<a:commandLink action="#{comunicacaoAction.setDestinatarioCiencia(bean)}" 
								execute="@this" limitRender="true" rendered="#{not comunicacaoAction.isCienciaConfirmada(bean)}"
								render="painelProrrogacaoPrazo, painelCiencia, painelDocumentos, pageBodyDialogMessage"
								onclick="infox.showLoading();" oncomplete="infox.hideLoading();">
								<h:graphicImage url="#{wiSkin.imageFolder}/search_16.png" title="#{infoxMessages['comunicacao.confirmarCiencia']}" />
							</a:commandLink>
							<a:commandLink action="#{comunicacaoAction.setDestinatarioProrrogacaoPrazo(bean)}"
								render="painelProrrogacaoPrazo, painelCiencia, painelDocumentos, pageBodyDialogMessage" 
								execute="@this" limitRender="true"
								rendered="#{comunicacaoAction.podePedirProrrogacaoPrazo(bean)}"
								onclick="infox.showLoading();" oncomplete="infox.hideLoading();">
								<h:graphicImage url="#{wiSkin.imageFolder}/time_16.png" title="#{infoxMessages['comunicacao.pedirProrrogacaoPrazo']}" />
							</a:commandLink>
					</rich:column>
					<rich:column>
						<f:facet name="header">#{infoxMessages['comunicacao.destinatario']}</f:facet>
						<h:outputText value="#{bean.nome}" />
					</rich:column>
                          <rich:column>
                              <f:facet name="header">#{infoxMessages['comunicacao.tipoComunicacao']}</f:facet>
                              <h:outputText value="#{bean.tipoComunicacao.descricao}" />
                          </rich:column>
					<rich:column>
						<f:facet name="header">#{infoxMessages['comunicacao.meioComunicacao']}</f:facet>
						<h:outputText value="#{bean.meioExpedicao}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">#{infoxMessages['comunicacao.dataEnvio']}</f:facet>
						<h:outputText value="#{bean.dataEnvio}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">#{infoxMessages['comunicacao.dataConfirmacao']}</f:facet>
						<h:outputText value="#{bean.dataConfirmacao}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">#{infoxMessages['comunicacao.responsavelConfirmacao']}</f:facet>
						<h:outputText value="#{bean.responsavelConfirmacao}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">#{infoxMessages['comunicacao.prazoFinal']}</f:facet>
						<h:outputText value="#{bean.prazoFinal}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">#{infoxMessages['comunicacao.statusProrrogacao']}</f:facet>
						<h:outputText value="-" />
					</rich:column>
					<rich:column>
						<f:facet name="header">#{infoxMessages['comunicacao.documentos']}</f:facet>
							<a:commandLink action="#{comunicacaoAction.setDestinatarioDocumentos(bean)}"
								execute="@this" limitRender="true"
								render="painelProrrogacaoPrazo, painelCiencia, painelDocumentos, pageBodyDialogMessage"
								onclick="infox.showLoading();" oncomplete="infox.hideLoading();">
								<h:graphicImage url="#{wiSkin.imageFolder}/file.gif" title="#{infoxMessages['comunicacao.documentos']}"/>
							</a:commandLink>
							<h:commandLink onclick="infox.openPopUp('download#{bean.idDestinatario}', '#{pathResolver.contextPath}/Processo/baixarComunicacao.seam?idDestinatario=#{bean.idDestinatario}','1024'); return false;">
								<h:graphicImage url="#{wiSkin.imageFolder}/jbpm/down.gif" title="#{infoxMessages['comunicacao.baixarComunicacao']}"/>
							</h:commandLink>
					</rich:column>
				</rich:dataTable>
			</h:form>
		</rich:collapsiblePanel>
	    <s:div id="painelCiencia">
	    	<rich:panel header="#{infoxMessages['comunicacao.confirmarCiencia']} - #{comunicacaoAction.destinatario.nome} / #{comunicacaoAction.destinatario.tipoComunicacao}" 
	    		rendered="#{comunicacaoAction.ciencia}">
	    		<h:form>
	    			<wi:inputDate past="true" id="dataCiencia" showRequired="true" label="#{infoxMessages['comunicacao.dataCiencia']}" 
	    				value="#{comunicacaoAction.dataCiencia}" startDate="#{comunicacaoAction.destinatario.comunicacao.dataInicio}"
                        errorMessage="#{infoxMessages['comunicacao.validator.dataCienciaIncorreta']}">
	    				<a:ajax event="change" render="@form" execute="@form" limitRender="true" />
	    			</wi:inputDate>
	    			
	    			<wi:selectBooleanCheckbox id="editorCiencia" label="#{infoxMessages['comunicacao.adicionarDocumentoEditorCiencia']}" 
							value="#{comunicacaoAction.editorCiencia}" >
						<a:ajax event="change" render="@form" limitRender="true" execute="@this" />
					</wi:selectBooleanCheckbox>
	    			
	    			<wi:selectOneMenuEntity id="classificacaoCiencia" showRequired="true" label="#{infoxMessages['processoDocumento.classificacaoDocumento']}"
	    				showLabelSelecione="true" value="#{comunicacaoAction.classificacaoDocumentoCiencia}"
	    				items="#{comunicacaoAction.classificacoesDocumento}">
	    				<a:ajax event="change" limitRender="true" render="@form" execute="@form" />
	    			</wi:selectOneMenuEntity>

					<s:div id="editorArquivoDiv" rendered="#{not empty comunicacaoAction.classificacaoDocumentoCiencia 
	    				and not empty comunicacaoAction.dataCiencia 
	    				and comunicacaoAction.editorCiencia}">
						<wi:editor id="documentoCienciaTexto" readonly="false"
							 value="#{comunicacaoAction.textoCiencia}" required="true" />
					</s:div>

					<s:div id="anexo" rendered="#{not empty comunicacaoAction.classificacaoDocumentoCiencia 
	    				and not empty comunicacaoAction.dataCiencia 
	    				and not empty comunicacaoAction.classificacaoDocumentoCiencia.extensaoArquivosList
	    				and not comunicacaoAction.editorCiencia}">
	    				<wi:fileUpload id="documentoComprovacaoCiencia" accept="#{comunicacaoAction.classificacaoDocumentoCiencia.acceptedTypes}"
	    					reRender="buttonGravar"/>
					</s:div>
					
					<s:div id="buttonGravar">
						<wi:commandButton id="gravar"
							value="#{infoxMessages['crud.update']}"
							action="comunicacaoAction.darCiencia()"
							reRender="pageBodyDialogMessage, comunicacoes, painelCiencia"
							rendered="#{documentoUploader.valido or (not empty comunicacaoAction.classificacaoDocumentoCiencia 
	    					and not empty comunicacaoAction.dataCiencia and comunicacaoAction.editorCiencia)}" />
					</s:div>
	    		</h:form>
	    	</rich:panel>
	    </s:div>
	    <s:div id="painelProrrogacaoPrazo">
	    	<rich:panel header="#{infoxMessages['comunicacao.prorrogacaoPrazo']} - #{comunicacaoAction.destinatario.nome} / #{comunicacaoAction.destinatario.tipoComunicacao}" 
	    		rendered="#{comunicacaoAction.prorrogacaoPrazo}">
	    		<h:form>
	    			<wi:selectOneMenuEntity id="classificacaoProrrogacao" label="#{infoxMessages['processoDocumento.classificacaoDocumento']}"
	    				value="#{comunicacaoAction.classificacaoDocumentoProrrogPrazo}" items="#{comunicacaoAction.classificacoesDocumentoProrrogacaoPrazo}"
	    				showLabelSelecione="true">
	    				<a:ajax event="change" limitRender="true" render="@form" execute="@form" />
	    			</wi:selectOneMenuEntity>
	    			<s:div id="anexo" rendered="#{not empty comunicacaoAction.classificacaoDocumentoProrrogPrazo 
	    				and not empty comunicacaoAction.classificacaoDocumentoProrrogPrazo.extensaoArquivosList}">
	    				<wi:fileUpload id="documentoProrrogacaoPrazo" accept="#{comunicacaoAction.classificacaoDocumentoProrrogPrazo.acceptedTypes}"
	    					reRender="btnGravar"/>
	    				<s:div id="btnGravar">
	                        <wi:commandButton id="gravar" value="#{infoxMessages['crud.update']}" action="comunicacaoAction.pedirProrrogacaoPrazo()" 
    	    						reRender="pageBodyDialogMessage, comunicacoes, painelProrrogacaoPrazo"
    	    						rendered="#{documentoUploader.valido}"/>
                    	</s:div>
                    </s:div>
	    		</h:form>
	    	</rich:panel>
	    </s:div>
	    <s:div id="painelDocumentos">
	    	<rich:panel header="#{infoxMessages['comunicacao.documentos']} - #{comunicacaoAction.destinatario.nome} / #{comunicacaoAction.destinatario.tipoComunicacao.descricao}"
	    		rendered="#{comunicacaoAction.documentos}">
	    		<h:form>
	    			<h:commandButton styleClass="buttons" action="#{comunicacaoAction.downloadComunicacao}" 
	    				value="#{infoxMessages['comunicacao.comunicacao']}"
	    				rendered="#{not empty comunicacaoAction.destinatario.documentoComunicacao.documentoBin.extensao}"/>
                    <h:commandButton styleClass="buttons"
                        onclick="infox.openPopUp('doc#{comunicacaoAction.destinatario.documentoComunicacao.documentoBin.id}', '#{pathResolver.contextPath}/Painel/documentoHTML.seam?idBin=#{comunicacaoAction.destinatario.documentoComunicacao.documentoBin.id}','1024'); return false;" 
                        value="#{infoxMessages['comunicacao.comunicacao']}"
                        rendered="#{empty comunicacaoAction.destinatario.documentoComunicacao.documentoBin.extensao}"/>
	    		</h:form>
	    		<rich:dataTable value="#{comunicacaoAction.documentosDestinatario}" var="documento" styleClass="dtable rf-dt-crud">
	    			<rich:column styleClass="dt-toolbar-col">
	    				<h:form>
	    					<h:commandLink action="#{comunicacaoAction.downloadDocumento(documento)}"
	    						rendered="#{not empty documento.documentoBin.extensao}">
								<h:graphicImage url="#{wiSkin.imageFolder}/jbpm/down.gif" title="#{infoxMessages['comunicacao.baixarDocumento']}"/>
							</h:commandLink>
							<a:commandLink rendered="#{empty documento.documentoBin.extensao}"
								onclick="infox.openPopUp('doc#{documento.documentoBin.id}', '#{pathResolver.contextPath}/Painel/documentoHTML.seam?idBin=#{documento.documentoBin.id}','1024'); return false;">
								<h:graphicImage url="#{wiSkin.imageFolder}/jbpm/down.gif" title="#{infoxMessages['comunicacao.baixarDocumento']}"/>
							</a:commandLink>
	    				</h:form>
	    			</rich:column>
	    			<rich:column>
	    				<f:facet name="header">#{infoxMessages['comunicacao.documento']}</f:facet>
	    				<h:outputText value="#{documento.descricao}" />
	    			</rich:column>
	    		</rich:dataTable>
	    	</rich:panel>
	    </s:div>
	</s:div>
</ui:composition>