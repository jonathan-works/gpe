<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:s="http://jboss.org/schema/seam/taglib"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:wi="http://www.itx.com.br/jsf"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich">

	<wi:commandButton id="criarComunicacao" value="Criar Comunicação"
		onclick="infox.openPopUp('_blank', '#{pathResolver.contextPath}/Processo/criarComunicacao.seam?jbpmProcessId=#{comunicacaoAction.jbpmProcessId}','1024'); hideLoading(); return false;" 
		rendered="#{s:hasRole('usuarioInterno')}" />
	<h:form>
		<a:jsFunction name="reloadRascunhos" render="rascunhos" limitRender="true" execute="@this" />
		<a:jsFunction name="reloadComunicacoes" render="comunicacoes" limitRender="true" execute="@this" />
	</h:form>
	<rich:collapsiblePanel switchType="client" id="rascunhos" header="Rascunhos">
		<wi:dataTable id="rascunhosTable" bean="#{modeloComunicacaoRascunhoList}" showSearchForm="false"
			values="#{modeloComunicacaoRascunhoList.list(5)}" rowId="#{row.id}">
			<ui:define name="headerToolBar" />
			<ui:define name="toolBar">
				<h:form>
					<a:commandLink execute="@this"
						onclick="infox.openPopUp('comunicacao#{row.id}', '#{pathResolver.contextPath}/Processo/criarComunicacao.seam?idModeloComunicacao=#{row.id}','1024'); return false;">
						<h:graphicImage url="#{wiSkin.imageFolder}/view.png" title="#{eppmessages['button.selecionar']}" />
					</a:commandLink>
				</h:form>
			</ui:define>
			<wi:columnOutputText columnHeader="Tipo de Comunicação" value="#{row.tipoComunicacao.descricao}"/>
		</wi:dataTable>
	</rich:collapsiblePanel>
	<rich:collapsiblePanel header="Comunicações" switchType="client" id="comunicacoes" rendered="#{not empty comunicacaoAction.comunicacoesDoProcesso}">
		<ui:repeat var="modeloComunicacao" value="#{comunicacaoAction.comunicacoesDoProcesso}">
			<rich:panel header="Comunicação - #{modeloComunicacao.tipoComunicacao.descricao}">
				<rich:dataTable value="#{comunicacaoAction.getDestinatarios(modeloComunicacao)}" 
					var="bean" styleClass="dtable rf-dt-crud">
					<rich:column styleClass="dt-toolbar-col" rendered="#{s:hasRole('usuarioInterno')}">
						<h:form>
							<a:commandLink action="#{comunicacaoAction.setDestinatarioCiencia(bean)}" 
								execute="@this" limitRender="true" rendered="#{not comunicacaoAction.isCienciaConfirmada(bean)}"
								render="painelProrrogacaoPrazo, painelCiencia, painelDocumentos, pageBodyDialogMessage"
								onclick="infox.showLoading();" oncomplete="infox.hideLoading();">
								<h:graphicImage url="#{wiSkin.imageFolder}/search_16.png" title="Confirmar Ciência" />
							</a:commandLink>
							<a:commandLink action="#{comunicacaoAction.setDestinatarioProrrogacaoPrazo(bean)}"
								render="painelProrrogacaoPrazo, painelCiencia, painelDocumentos, pageBodyDialogMessage" 
								execute="@this" limitRender="true"
								onclick="infox.showLoading();" oncomplete="infox.hideLoading();">
								<h:graphicImage url="#{wiSkin.imageFolder}/time_16.png" title="Pedir Prorrogação de Prazo" />
							</a:commandLink>
						</h:form>
					</rich:column>
					<rich:column>
						<f:facet name="header">Destinatário</f:facet>
						<h:outputText value="#{bean.nome}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Meio de Expedição</f:facet>
						<h:outputText value="#{bean.meioExpedicao}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Data de Envio</f:facet>
						<h:outputText value="#{bean.dataEnvio}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Data de Confirmação</f:facet>
						<h:outputText value="#{bean.dataConfirmacao}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Confirmado Por</f:facet>
						<h:outputText value="#{bean.responsavelConfirmacao}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Prazo de Atendimento</f:facet>
						<h:outputText value="#{bean.prazoAtendimento}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Prazo Final</f:facet>
						<h:outputText value="#{bean.prazoFinal}" />
					</rich:column>
					<rich:column>
						<f:facet name="header">Documentos</f:facet>
						<h:form>
							<a:commandLink action="#{comunicacaoAction.setDestinatarioDocumentos(bean)}"
								execute="@this" limitRender="true"
								render="painelProrrogacaoPrazo, painelCiencia, painelDocumentos, pageBodyDialogMessage"
								onclick="infox.showLoading();" oncomplete="infox.hideLoading();">
								<h:graphicImage url="#{wiSkin.imageFolder}/file.gif" title="Visualizar Documentos"/>
							</a:commandLink>
							<h:commandLink action="#{comunicacaoAction.downloadComunicacao(bean)}">
								<h:graphicImage url="#{wiSkin.imageFolder}/jbpm/down.gif" title="Download"/>
							</h:commandLink>
						</h:form>
					</rich:column>
				</rich:dataTable>
			</rich:panel>
		</ui:repeat>
	</rich:collapsiblePanel>
    <s:div id="painelCiencia">
    	<rich:panel header="Informar Ciência - #{comunicacaoAction.destinatario.nome} / #{comunicacaoAction.destinatario.tipoComunicacao}" 
    		rendered="#{comunicacaoAction.ciencia}">
    		<h:form>
    			<wi:inputDate past="true" id="dataCiencia" showRequired="true" label="Data Ciência" 
    				value="#{comunicacaoAction.dataCiencia}">
    				<a:ajax event="change" render="@form" execute="@form" limitRender="true" />
    			</wi:inputDate>
    			<wi:selectOneMenuEntity id="classificacaoCiencia" showRequired="true" label="Classificação de Documento"
    				showLabelSelecione="true" value="#{comunicacaoAction.classificacaoDocumento}"
    				disabled="#{comunicacaoAction.classificacoesDocumento.size eq 1}"
    				items="#{comunicacaoAction.classificacoesDocumento}">
    				<a:ajax event="change" limitRender="true" render="@form" execute="@form" />
    			</wi:selectOneMenuEntity>
    			<wi:fileUpload id="documentoComprovacaoCiencia" accept="#{comunicacaoAction.classificacaoDocumento.acceptedTypes}"
    				rendered="#{not empty comunicacaoAction.classificacaoDocumento and not empty comunicacaoAction.dataCiencia and not empty comunicacaoAction.classificacaoDocumento.extensaoArquivosList}"
    				reRender="@form"/>
    			<wi:commandButton id="gravar" value="Gravar" action="comunicacaoAction.darCiencia()" 
    				reRender="pageBodyDialogMessage, comunicacoes, painelCiencia"
    				rendered="#{documentoUploader.valido}"/>
    		</h:form>
    	</rich:panel>
    </s:div>
    <s:div id="painelProrrogacaoPrazo">
    	<rich:panel header="Prorrogação de Prazo - #{comunicacaoAction.destinatario.nome} / #{comunicacaoAction.destinatario.tipoComunicacao}" 
    		rendered="#{comunicacaoAction.prorrogacaoPrazo}">
    		<h:form>
    			<wi:outputText id="classificacaoProrrogacao" label="Classificação de Documento"
    				value="#{comunicacaoAction.classificacaoDocumento}"/>
    			<wi:fileUpload id="documentoProrrogacaoPrazo" />
    		</h:form>
    	</rich:panel>
    </s:div>
    <s:div id="painelDocumentos">
    	<rich:panel header="Documentos - #{comunicacaoAction.destinatario.nome} / #{comunicacaoAction.destinatario.tipoComunicacao}"
    		rendered="#{comunicacaoAction.documentos}">
    		<rich:dataTable value="#{comunicacaoAction.documentosDestinatario}" var="documento" styleClass="dtable rf-dt-crud">
    			<rich:column styleClass="dt-toolbar-col">
    				<h:form>
    					<h:commandLink action="#{comunicacaoAction.downloadDocumento(documento)}"
    						rendered="#{not empty documento.documentoBin.extensao}">
							<h:graphicImage url="#{wiSkin.imageFolder}/jbpm/down.gif" title="Download"/>
						</h:commandLink>
						<a:commandLink rendered="#{empty documento.documentoBin.extensao}"
							onclick="infox.openPopUp('doc#{documento.documentoBin.id}', '#{pathResolver.contextPath}/Painel/documentoHTML.seam?idBin=#{documento.documentoBin.id}','1024'); return false;">
							<h:graphicImage url="#{wiSkin.imageFolder}/jbpm/down.gif" title="Download"/>
						</a:commandLink>
    				</h:form>
    			</rich:column>
    			<rich:column>
    				<f:facet name="header">Documento</f:facet>
    				<h:outputText value="#{documento.descricao}" />
    			</rich:column>
    		</rich:dataTable>
    	</rich:panel>
    </s:div>
</ui:composition>