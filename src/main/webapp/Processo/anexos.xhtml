<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:s="http://jboss.org/schema/seam/taglib"
  xmlns:wi="http://www.itx.com.br/jsf"
  xmlns:rich="http://richfaces.org/rich"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:a="http://richfaces.org/a4j">
    <a:jsFunction name="selectDocumento" immediate="true"
        execute="@this" render="historicoDocumentoPanelDiv" limitRender="true" status=":status">
        <a:param name="idDocumento" assignTo="#{documentoProcessoAction.idDocumento}" converter="javax.faces.Integer"/>
    </a:jsFunction>
    <wi:dataTable
        values="#{documentoList.list(15)}"
        bean="#{documentoList}"
        tableTitle="#{eppmessages['processo.documentos']} #{home.instance}"
        id="documentoList"
        rowId="#{row.id}"
        showSearchForm="false"
        panelStyleClass="full-sized">
        <ui:define name="headerToolBar" />
        <wi:columnOutputText 
            styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
            columnId="numeroDocumento"
            columnHeader="#{eppmessages['processoDocumento.numeroDocumento']}"
            value="#{row.numeroDocumento}" />
        <wi:columnOutputText
            styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
            columnId="usuarioInclusao"
            columnHeader="#{eppmessages['processoDocumento.usuarioInclusao']}"
            value="#{row.usuarioInclusao}" />
        <wi:columnDateTime
            styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
            columnId="dataInclusao"
            columnHeader="#{eppmessages['processoDocumento.dataInclusao']}"
            value="#{row.dataInclusao}" />
        <wi:columnOutputText 
            styleOutputText="#{row.excluido ? 'text-decoration:line-through; color:red;' : ''}"
            columnId="descricao"
            columnHeader="#{eppmessages['processoDocumentoBin.documento']}"
            value="#{row.descricao}" />
        <ui:define name="toolBar">
            <s:link
                target="idJan#{row.id}"
                rendered="#{not empty row.documentoBin.assinaturas}"
                view="/Processo/Consulta/validaDocumento.xhtml"
                onclick="infox.openPopUp('idJan#{row.id}', '', 650, 160, 450, 450);">
                <h:graphicImage
                    title="#{eppmessages['assinaturas.validar']}"
                    alt="#{eppmessages['assinaturas.validar']}"
                    url="#{a4jSkin.imgFolder}/lock.png" />
                <f:param value="#{row.id}" name="idDocumento" />
            </s:link>
            <s:link
                target="idJan#{row.id}"
                rendered="#{empty row.documentoBin.assinaturas}"
                view="/Processo/Consulta/validaDocumento.xhtml"
                onclick="infox.openPopUp('idJan#{row.id}', '', 650, 200, 450, 450);">
                <h:graphicImage
                    title="#{eppmessages['assinaturas.assinar']}"
                    alt="#{eppmessages['assinaturas.assinar']}"
                    url="#{a4jSkin.imgFolder}/lock_unlock.png" />
                <f:param value="#{row.id}" name="idDocumento" />    
            </s:link>
            <h:graphicImage styleClass="opacityHover" url="#{a4jSkin.imgFolder}/view.png" 
                            title="#{eppmessages['button.historico']}" 
                            rendered="#{documentoProcessoAction.hasHistoricoDocumento(rowId) and documentoProcessoAction.podeUsuarioVerHistorico()}"
                            onmouseup="selectDocumento(#{rowId});"/>
            
            <h:graphicImage styleClass="opacityHover" url="#{a4jSkin.imgFolder}/remove.png"
                            rendered="#{not row.excluido and documentoProcessoAction.podeUsuarioExcluirRestaurar()}" 
                            title="#{eppmessages['button.delete']}"
                            onmouseup="#{rich:component('requestMotivoPanel')}.show(); setValuesToExcludeRestore(true, #{rowId}, #{row.numeroDocumento}, '#{row.descricao}', '#{row.classificacaoDocumento.descricao}');"/>
            
            <h:graphicImage styleClass="opacityHover" url="#{a4jSkin.imgFolder}/stock_undelete.png"
                            rendered="#{row.excluido and documentoProcessoAction.podeUsuarioExcluirRestaurar()}" 
                            title="#{eppmessages['button.restaurar']}"
                            onmouseup="#{rich:component('requestMotivoPanel')}.show(); setValuesToExcludeRestore(false, #{rowId}, #{row.numeroDocumento}, '#{row.descricao}', '#{row.classificacaoDocumento.descricao}');"/>
        </ui:define>
    </wi:dataTable>
    
    <script type="text/javascript">
        function clearFieldsExcludeRestore() {
            var maxlength = 4000;
            #{rich:jQuery('motivoExclusaoRestauracao')}.val('');
            #{rich:jQuery('motivoExclusaoRestauracaocounterDiv')}.text('(0 / '+maxlength+')');
            $('.errorFields.errors').remove();
            $('.errors').removeClass('errors');
        }
        
        function setValuesToExcludeRestore(isExclusao, idDocumento, numeroDocumento, dsDocumento, classificacao) {
            #{rich:jQuery('hiddenIdDocumento')}.val(idDocumento);
            #{rich:jQuery('numeroDocumento')}.text(numeroDocumento);
            #{rich:jQuery('processoDocumento')}.text(dsDocumento);
            #{rich:jQuery('tipoProcessoDocumentoOutPanel')}.text(classificacao);
            if (isExclusao) {
                $('.rf-pp-hdr.motivo-header > div').text('Exclusão de Documento');
                #{rich:jQuery('excluirRestaurarDocButton')}.attr('value','Excluir');
                alterarMotivoDaExlusaoRestauracao('Motivo da Exclusão');
            } else {
                $('.rf-pp-hdr.motivo-header > div').text('Restauração de Documento');
                #{rich:jQuery('excluirRestaurarDocButton')}.attr('value', 'Restaurar');
                alterarMotivoDaExlusaoRestauracao('Motivo da Restauração');
            }
        }

        function alterarMotivoDaExlusaoRestauracao(label){
            var labelTextArea = $('label[for=\''+#{rich:jQuery('motivoExclusaoRestauracao')}.attr('id')+'\']');
            labelTextArea.text(label);
            labelTextArea.append($("<span> * </span>").addClass("required"));
        }

        function atualizarOnValidationFailed() {
            var teste = $('.rf-pp-hdr.motivo-header').children(0).text();
            if (teste === 'Exclusão de Documento') {
                #{rich:jQuery('excluirRestaurarDocButton')}.attr('value','Excluir');
                alterarMotivoDaExlusaoRestauracao('Motivo da Exclusão');
            } else {
                #{rich:jQuery('excluirRestaurarDocButton')}.attr('value', 'Restaurar');
                alterarMotivoDaExlusaoRestauracao('Motivo da Restauração');
            }
        }
    </script>
    
    <rich:popupPanel id="requestMotivoPanel" header="teste" headerClass="motivo-header" moveable="true" 
                     show="false" resizeable="true" minWidth="690" minHeight="310"
                     onbeforehide="clearFieldsExcludeRestore();">
        <f:facet name="controls">
            <h:graphicImage id="mp_taskNodeCloseBtn" styleClass="mp-close" value="#{a4jSkin.imgFolder}/closeMP.gif" 
                            onmouseup="#{rich:component('requestMotivoPanel')}.hide();"/>
        </f:facet>
        <wi:outputText id="numeroDocumento" label="#{eppmessages['processoDocumento.numeroDocumento']}" />
        
        <wi:outputText id="tipoProcessoDocumentoOutPanel" label="#{eppmessages['tipoProcessoDocumento.tipoProcessoDocumento']}" />
                        
        <wi:outputText id="processoDocumento" label="#{eppmessages['processoDocumentoBin.documento']}" />
        <h:form id="excluirRestaurarDocumentoForm">
          <div>
            <h:inputHidden id="hiddenIdDocumento" value="#{documentoProcessoAction.idDocumentoAlter}" converter="javax.faces.Integer"/>
            <wi:inputTextarea id="motivoExclusaoRestauracao"
                maxlength="4000" required="true" cols="60" rows="5"
                label="Motivo" value="#{documentoProcessoAction.motivoExclusaoRestauracao}">
                <f:validator validatorId="emptyStringValidator"/>
            </wi:inputTextarea>
          </div>
          <div>
            <a:commandButton id="excluirRestaurarDocButton" 
                actionListener="#{documentoProcessoAction.exclusaoRestauracaoDocumento()}"
                limitRender="true" execute="@form"
                onclick="infox.showLoading();"
                oncomplete="infox.hideLoading(); if(#{not facesContext.validationFailed}){#{rich:component('requestMotivoPanel')}.hide();}else{atualizarOnValidationFailed();}"
                value="Enviar"
                render="@form, documentoList, pageBodyDialogMessage"
                styleClass="buttons"/>
          </div>
        </h:form>
    </rich:popupPanel>
    
    <s:div id="historicoDocumentoPanelDiv" style="margin-top:20px; width:100%;">
        <rich:panel id="historicoDocumentoPanel" headerClass=""
                    rendered="#{not empty documentoProcessoAction.processoDocumentoSelected}"
                    bodyClass="dtable-p-b" styleClass="dtable-p" style="width:100%;" >
                    
            <f:facet name="header">
                <h:outputText value="#{eppmessages['historicoStatusDocumento.tableTile']}" />
                <h:graphicImage value="#{a4jSkin.imgFolder}/closeMP.gif" onmouseup="selectDocumento(0);" style="float:right;"/>
            </f:facet>
            
            <rich:dataTable id="historicoDocumentoDataTable"
                    var="historicoDocumento" style="width:100%"
                    value="#{documentoProcessoAction.listHistoricoStatusDocumento}">
                    
                <rich:column style="text-align:center;">
                    <f:facet name="header">#{eppmessages['historicoStatusDocumento.nomeUsuarioAlterou']}</f:facet>
                    <h:outputText value="#{historicoDocumento.usuarioAlteracao.nomeUsuario}" />
                </rich:column>
                
                <rich:column style="text-align:center;">
                    <f:facet name="header">#{eppmessages['historicoStatusDocumento.dataAlteracao']}</f:facet>
                    <h:outputText value="#{historicoDocumento.dataAlteracao}">
                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>
                    </h:outputText>
                </rich:column>
                
                <rich:column style="text-align:center;">
                    <f:facet name="header">Tipo Operação</f:facet>
                    <h:outputText value="#{historicoDocumento.tipoAlteracaoDocumento.label}" />
                </rich:column>
                
                <rich:column>
                    <f:facet name="header">#{eppmessages['historicoStatusDocumento.motivo']}</f:facet>
                    <h:outputText value="#{historicoDocumento.motivo}" />
                </rich:column>
                
            </rich:dataTable>              
        </rich:panel>
     </s:div>
</ui:composition>