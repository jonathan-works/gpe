<?xml version="1.0" encoding="UTF-8"?>
<!--
  IBPM - Ferramenta de produtividade Java
  Copyright (c) 1986-2009 Infox Tecnologia da Informação Ltda.
 
  Este programa é software livre; você pode redistribuí-lo e/ou modificá-lo 
  sob os termos da GNU GENERAL PUBLIC LICENSE (GPL) conforme publicada pela 
  Free Software Foundation; versão 2 da Licença.
  Este programa é distribuído na expectativa de que seja útil, porém, SEM 
  NENHUMA GARANTIA; nem mesmo a garantia implícita de COMERCIABILIDADE OU 
  ADEQUAÇÃO A UMA FINALIDADE ESPECÍFICA.
  
  Consulte a GNU GPL para mais detalhes.
  Você deve ter recebido uma cópia da GNU GPL junto com este programa; se não, 
  veja em http://www.gnu.org/licenses/  
-->
<ui:composition
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:s="http://jboss.org/schema/seam/taglib"
    xmlns:wi="http://www.itx.com.br/jsf">

    <f:subview id="nodes">

        <s:div id="divNodesGeral">

            <s:div id="nodesDiv" >

                <s:div >
                    <ui:decorate template="dataTable.xhtml">
                        <ui:param name="values" value="#{nodeFitter.nodes}" />
                        <ui:param name="styleClass" value="tabelaVariaveis" />
                        <ui:param name="id" value="nodesTable" />
                        <ui:param name="style" value="width:100%" />
                        <ui:define name="headerToolBar">
                            <a:commandLink
                                action="#{nodeFitter.setCurrentNode(null)}"
                                render="nodesDiv"
                                limitRender="true">

                                <h:graphicImage
                                    title="Adicionar nó"
                                    
                                    url="/img/add.gif" />

                            </a:commandLink>

                        </ui:define>
                        <ui:define name="toolBar">

                            <s:div >

                                <h:graphicImage
                                    title="Excluir nó"
                                    
                                    url="/img/remove.png"
                                    styleClass="opacityHover">

                                    <a:ajax
                                        event="click"
                                        listener="#{nodeFitter.removeNode(row)}"
                                        onbeforesubmit="if(!confirm('Confirma?')) return false;"
                                        execute="@this"
                                        render="nodesDiv"
                                        limitRender="true" />

                                </h:graphicImage>
                                <h:graphicImage
                                    title="Subir na ordem"
                                    
                                    rendered="#{key != 0}"
                                    url="/img/jbpm/up.gif"
                                    styleClass="opacityHover">

                                    <a:ajax
                                        event="click"
                                        listener="#{nodeFitter.moveUp(row)}"
                                        execute="@this"
                                        render="nodesTable"
                                        limitRender="true" />

                                </h:graphicImage>
                                <h:graphicImage
                                    title="Descer na ordem"
                                    
                                    rendered="#{key lt nodeFitter.nodes.size - 1}"
                                    url="/img/jbpm/down.gif"
                                    styleClass="opacityHover">

                                    <a:ajax
                                        event="click"
                                        listener="#{nodeFitter.moveDown(row)}"
                                        execute="@this"
                                        render="nodesTable"
                                        limitRender="true" />

                                </h:graphicImage>

                            </s:div>

                        </ui:define>
                        <ui:define name="columns">

                            <rich:column>

                                <f:facet name="header">Nós</f:facet>
                                <ui:param
                                    name="current"
                                    value="#{row == nodeFitter.currentNode}" />
                                <ui:param
                                    name="styleNodeName"
                                    value="#{current ? 'font-weight:bold' : ''}" />
                                <a:commandLink
                                    action="#{nodeFitter.setCurrentNode(row)}"
                                    
                                    render="divNodesGeral"
                                    execute="@this"
                                    limitRender="true">

                                    <a:outputPanel>

                                        <h:panelGrid
                                            columns="2"
                                            cellspacing="0"
                                            cellpadding="0">

                                            <h:graphicImage
                                                url="/img/jbpm/#{nodeFitter.getIcon(row)}.gif"
                                                title="#{row.nodeType}"
                                                 />
                                            <h:outputText
                                                value="#{row.name}"
                                                
                                                title="#{nodeFitter.getMessage(row)}" />

                                        </h:panelGrid>

                                    </a:outputPanel>

                                </a:commandLink>

                            </rich:column>

                        </ui:define>

                    </ui:decorate>

                </s:div>

                <s:div
                    id="nodeDiv"
                    >

                    <rich:panel
                        bodyClass="panel"
                        
                        rendered="#{!empty nodeFitter.currentNode}">

                        <f:facet name="header">

                            <h:panelGrid
                                columns="2"
                                cellpadding="0"
                                cellspacing="0">

                                <h:graphicImage
                                    url="/img/jbpm/#{nodeFitter.getIcon(nodeFitter.currentNode)}.gif"
                                    title="#{nodeFitter.currentNode.nodeType}"
                                     />
                                <rich:inplaceInput
                                    
                                    value="#{nodeFitter.nodeName}"
                                    inputWidth="150px"
                                    title="Clique para alterar o nome do nó"
                                    oninputkeyup="this.value = this.value.replace('/','_')">

                                    <a:ajax
                                        event="change"
                                        execute="@this"
                                        render="nodesTable" />

                                </rich:inplaceInput>

                            </h:panelGrid>

                        </f:facet>

                        <s:fragment
                            rendered="#{nodeFitter.currentNode.nodeType != 'StartState'}">

                            <ui:include src="transition.xhtml">

                                <ui:param
                                    name="type"
                                    value="from" />

                            </ui:include>

                        </s:fragment>

                        <s:fragment
                            rendered="#{nodeFitter.currentNode.nodeType != 'EndState'}">

                            <ui:include src="transition.xhtml">

                                <ui:param
                                    name="type"
                                    value="to" />

                            </ui:include>

                        </s:fragment>
                        <s:fragment
                            rendered="#{nodeFitter.currentNode.nodeType == 'Task'}">

                            <ui:include src="tasks.xhtml" />

                        </s:fragment>

                        <s:fragment
                            rendered="#{nodeFitter.currentNode.nodeType == 'Task'}">

                            <ui:include src="timers.xhtml" />

                        </s:fragment>

                        <s:div rendered="#{! empty nodeFitter.nodeForm}">

                            <ui:include
                                src="forms/#{nodeFitter.nodeForm}.xhtml" />

                        </s:div>


                        <rich:collapsiblePanel
                            switchType="ajax"
                            
                            expanded="false"
                            header="Descrição">

                            <wi:inputTextarea
                                id="nodeDescription"
                                label=""
                                
                                value="#{nodeFitter.currentNode.description}">

                                <a:ajax
                                    event="change"
                                    execute="@this"
                                    limitRender="true" />

                            </wi:inputTextarea>



                        </rich:collapsiblePanel>

                        <rich:collapsiblePanel
                            switchType="ajax"
                            
                            expanded="false"
                            header="Eventos">

                            <ui:include src="events.xhtml">

                                <ui:param
                                    name="parent"
                                    value="#{nodeFitter.nodeHandler}" />
                                <ui:param
                                    name="id"
                                    value="nodeEvent" />

                            </ui:include>

                        </rich:collapsiblePanel>


                    </rich:panel>
                    <br />
                    <rich:panel
                        header="Novo nó"
                        
                        rendered="#{empty nodeFitter.currentNode}">


                        <rich:dataTable
                            id="nodeTypes"
                            
                            value="#{nodeFitter.nodeTypes}"
                            var="node">

                            <f:facet name="header">Tipo de nó</f:facet>
                            <rich:column >

                                <h:graphicImage
                                    url="/img/jbpm/${node[0]}.gif" />

                            </rich:column>
                            <rich:column>
				 				#{node[1]}
				 			</rich:column>
                            <rich:column >

                                <h:graphicImage
                                    url="/img/jbpm/#{nodeFitter.newNodeType == node[0] ? 'checked' : 'unchecked'}.gif">

                                    <a:ajax
                                        event="click"
                                        listener="#{nodeFitter.setNewNodeType(node[0])}"
                                        execute="@this"
                                        render="nodeTypes,inTransition"
                                        limitRender="true" />

                                </h:graphicImage>

                            </rich:column>

                        </rich:dataTable>

                        <s:div >

                            <s:decorate
                                template="/WEB-INF/xhtml/components/templates/edit.xhtml">

                                <ui:define name="label">Nome:</ui:define>
                                <h:inputText
                                    id="newNodeName"
                                    label="Nome"
                                    styleClass="inputText"
                                    value="#{nodeFitter.newNodeName}">

                                    <a:ajax
                                        event="change"
                                        execute="@this"
                                        limitRender="true" />

                                </h:inputText>

                            </s:decorate>
                            <s:decorate
                                template="/WEB-INF/xhtml/components/templates/edit.xhtml">

                                <ui:define name="label">Inserir após:</ui:define>
                                <h:selectOneMenu
                                    id="after"
                                    
                                    value="#{nodeFitter.newNodeAfter}">

                                    <f:selectItems
                                        value="#{nodeFitter.nodesItems}" />
                                    <a:ajax
                                        event="click"
                                        execute="@this"
                                        limitRender="true" />

                                </h:selectOneMenu>

                            </s:decorate>
                            <s:div id="inTransition">

                                <s:decorate
                                    rendered="#{nodeFitter.newNodeType != 'EndState'}"
                                    template="/WEB-INF/xhtml/components/templates/edit.xhtml">

                                    <ui:define name="label">Na transição:</ui:define>
                                    <h:selectOneMenu
                                        id="after"
                                        
                                        value="#{transitionFitter.newNodeTransitionName}">

                                        <f:selectItems
                                            value="#{transitionFitter.getTransitionsItems(nodeFitter.getNodes())}" />
                                        <a:ajax
                                            event="click"
                                            execute="@this"
                                            limitRender="true" />

                                    </h:selectOneMenu>

                                </s:decorate>

                            </s:div>
                            <a:commandButton
                                styleClass="buttons"
                                value="Inserir"
                                render="nodesDiv"
                                execute="@this"
                                action="#{nodeFitter.addNewNode()}"
                                limitRender="true" />

                        </s:div>

                    </rich:panel>


                </s:div>

            </s:div>

        </s:div>

        <wi:modalPanel
            id="transitionCondition"
            height="150"
            width="550"
            resizeable="false"
            labelHeader="Condição para a transição">

            <a:commandLink
                id="#{type}Link"
                render="actionTemplate"
                onclick="idTextarea='form:nodes:conditionInputDecoration:conditionInput'"
                action="#{actionTemplateHandler.setCurrentActionTemplate(transitionFitter.getCurrentTransition().condition)}"
                limitRender="true">

                <h:graphicImage
                    url="/img/jbpm/wizard.gif"
                    title="Assistente para expressão"
                     />
                <rich:componentControl
                    target="actionTemplatePanel"
                    operation="show"
                    event="complete" />

            </a:commandLink>
            <div >

                <wi:inputTextarea
                    id="conditionInput"
                    value="#{transitionFitter.getCurrentTransition().condition}"
                    widthDiv="500px"
                    
                    label="Expressão:">

                    <a:ajax
                        event="change"
                        execute="@this"
                        render="transitiontoTable,transitionfromTable"
                        limitRender="true" />

                </wi:inputTextarea>
                <a:commandButton
                    type="button"
                    
                    onclick="Richfaces.hideTopModalPanel()"
                    styleClass="buttons buttons"
                    value="OK" />

            </div>

        </wi:modalPanel>
    </f:subview>   

</ui:composition>
