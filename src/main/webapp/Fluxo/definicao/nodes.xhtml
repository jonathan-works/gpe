<?xml version="1.0" encoding="ISO-8859-1"?>


<!--
  IBPM - Ferramenta de produtividade Java
  Copyright (c) 1986-2009 Infox Tecnologia da Informação Ltda.
 
  Este programa é software livre; você pode redistribuí-lo e/ou modificá-lo 
  sob os termos da GNU GENERAL PUBLIC LICENSE (GPL) conforme publicada pela 
  Free Software Foundation; versão 2 da Licença.
  Este programa é distribuído na expectativa de que seja útil, porém, SEM 
  NENHUMA GARANTIA; nem mesmo a garantia implícita de COMERCIABILIDADE OU 
  ADEQUAÇÃO A UMA FINALIDADE ESPECÍFICA.
  
  Consulte a GNU GPL para mais detalhes.
  Você deve ter recebido uma cópia da GNU GPL junto com este programa; se não, 
  veja em http://www.gnu.org/licenses/  
-->

<ui:composition	xmlns="http://www.w3.org/1999/xhtml"
				xmlns:s="http://jboss.org/schema/seam/taglib"
				xmlns:ui="http://java.sun.com/jsf/facelets"
				xmlns:c="http://java.sun.com/jsp/jstl/core"
				xmlns:f="http://java.sun.com/jsf/core"
				xmlns:h="http://java.sun.com/jsf/html"
				xmlns:wi="http://www.itx.com.br/jsf"
				xmlns:a="http://richfaces.org/a4j"
				xmlns:rich="http://richfaces.org/rich">

	<f:subview id="nodes">
	<s:div id="divNodesGeral">
		<s:div id="nodesDiv">
			<s:div style="width:200px; float:left;">
			<ui:decorate template="dataTable.xhtml">
				<ui:param name="values" value="#{processBuilder.nodes}" />
				<ui:param name="styleClass" value="tabelaVariaveis" />
				<ui:param name="id" value="nodesTable" />
				<ui:param name="style" value="width:100%" />
				<ui:define name="headerToolBar">
					<a:commandLink action="#{processBuilder.setCurrentNode(null)}"
						reRender="nodesDiv">
						<h:graphicImage title="Adicionar nó"
							style="cursor:pointer" 
							url="/img/add.gif"
						/>
					</a:commandLink>
				</ui:define>
				<ui:define name="toolBar">
					<s:div style="width:40px; text-align:left">
						<h:graphicImage title="Excluir nó"
							style="cursor:pointer" 
							url="/img/remove.png">
							<a:support event="onclick" 
								action="#{processBuilder.removeNode(row)}"
								ajaxSingle="true"
								onclick="if(!confirm('Confirma?')) return false;"
								reRender="nodesDiv"/>
						</h:graphicImage>
						<h:graphicImage title="Subir na ordem"
							style="cursor:pointer" 
							rendered="#{key != 0}"
							url="/img/jbpm/up.gif">
							<a:support event="onclick" 
								action="#{processBuilder.moveUp(row)}"
								ajaxSingle="true"
								reRender="nodesTable"/>
						</h:graphicImage>
						<h:graphicImage title="Descer na ordem"
							style="cursor:pointer" 
							rendered="#{key lt processBuilder.nodes.size - 1}"
							url="/img/jbpm/down.gif">
							<a:support event="onclick" 
								action="#{processBuilder.moveDown(row)}"
								ajaxSingle="true"
								reRender="nodesTable"/>
						</h:graphicImage>
					</s:div>
				</ui:define>
				<ui:define name="columns">
					<rich:column>
						<f:facet name="header">Nós</f:facet>
						<ui:param name="current" value="#{row == processBuilder.currentNode}" />
						<ui:param name="styleNodeName" 
							value="#{current ? 'font-weight:bold' : ''}" />
						 <a:commandLink action="#{processBuilder.setCurrentNode(row)}"
						 		style="float:left;"
						 		reRender="divNodesGeral"
						 		ajaxSingle="true"
						 		limitToList="true">
						 		<a:outputPanel>
						 			<h:panelGrid columns="2" cellspacing="0" cellpadding="0">
										<h:graphicImage url="/img/jbpm/#{processBuilder.getIcon(row)}.gif" 
											title="#{row.nodeType}"
											style="margin-right:5px; margin-left:2px" />
									 	<h:outputText value="#{row.name}" 
									 		style="#{styleNodeName}; #{!empty processBuilder.getMessage(row) ? 'color:red' : ''} " 
									 		title="#{processBuilder.getMessage(row)}"/>
						 			</h:panelGrid>
						 		</a:outputPanel>
						 </a:commandLink>
					</rich:column>
				</ui:define>
			</ui:decorate>
			</s:div>
			
			<s:div id="nodeDiv" style="width:auto; float:left; margin-left:5px">
				<rich:panel bodyClass="panel"
					style="overflow:visible"
					rendered="#{!empty processBuilder.currentNode}">
					<f:facet name="header">
						<h:panelGrid columns="2" cellpadding="0" cellspacing="0">
							<h:graphicImage url="/img/jbpm/#{processBuilder.getIcon(processBuilder.currentNode)}.gif" 
								title="#{processBuilder.currentNode.nodeType}"
								style="margin-right:5px" />
							<rich:inplaceInput style="border:none; background-color:transparent"
								value="#{processBuilder.nodeName}"
								inputWidth="150px"
								title="Clique para alterar o nome do nó"
								selectOnEdit="true"
								oninputkeyup="this.value = this.value.replace('/','_')"
								>
								<a:support event="onviewactivated" 
									ajaxSingle="true"
									reRender="nodesTable"/>
							</rich:inplaceInput>
						</h:panelGrid>
					</f:facet>
					
					<s:fragment rendered="#{processBuilder.currentNode.nodeType != 'StartState'}">
						<ui:include src="transition.xhtml">
							<ui:param name="type" value="from" />
						</ui:include>
					</s:fragment>
	
					<s:fragment rendered="#{processBuilder.currentNode.nodeType != 'EndState'}">
						<ui:include src="transition.xhtml">
							<ui:param name="type" value="to" />
						</ui:include>
					</s:fragment>
	
					<s:fragment rendered="#{processBuilder.currentNode.nodeType == 'Task' || processBuilder.currentNode.nodeType == 'StartState'}">
						<ui:include src="tasks.xhtml" />
					</s:fragment>
	
					<s:fragment rendered="#{processBuilder.currentNode.nodeType == 'Task'}">
						<ui:include src="timers.xhtml" />
					</s:fragment>
	
					<c:if test="#{! empty processBuilder.nodeForm}">
						<s:div style="margin-left:3px">
							<ui:include src="forms/#{processBuilder.nodeForm}.xhtml" />
						</s:div>
					</c:if>
					
	
					<rich:collapsiblePanel switchType="support"
						ajaxSingle="true"
						style="margin:3px; width:705px; clear:both"
						opened="false" label="Descrição">
						<wi:inputTextarea id="nodeDescription"
				 			label=""
				 			style="width:680px; height:200px"
				 			value="#{processBuilder.currentNode.description}">
				 			<wi:ajaxSupport />
				 		</wi:inputTextarea>
						
	
					</rich:collapsiblePanel>
	
					<rich:collapsiblePanel switchType="support"
											ajaxSingle="true"
											style="margin:3px; width:705px; clear:both"
											opened="false" 
											label="Eventos">
						<ui:include src="events.xhtml"> 
							<ui:param name="parent" value="#{processBuilder.nodeHandler}" />
							<ui:param name="id" value="nodeEvent" />
						</ui:include>
					</rich:collapsiblePanel>
					<rich:collapsiblePanel switchType="support"
											ajaxSingle="true"
											style="margin:3px; width:705px; clear:both"
											opened="false" 
											label="Eventos de Tarefa"
											rendered="#{processBuilder.currentNode.nodeType == 'Task'}">
						<c:if test="#{tarefaEventoHome.enableEvents}">
							<ui:include src="taskEvents.xhtml"> 
								<ui:param name="parent" value="#{processBuilder.nodeHandler}" />
								<ui:param name="id" value="nodeEvent" />
							</ui:include>
						</c:if>
						<c:if test="#{!tarefaEventoHome.enableEvents}">
							<h:outputText value="É necessário publicar o fluxo para adicionar um evento!" />
						</c:if>
					</rich:collapsiblePanel>
	
				</rich:panel>
				<br/>
				<rich:panel header="Novo nó" style="height: 290px; width:480px"
					rendered="#{empty processBuilder.currentNode}">

				 		<rich:dataTable id="nodeTypes" style="width: 150px; float:left"
				 			value="#{processBuilder.nodeTypes}" var="node">
				 			<f:facet name="header">Tipo de nó</f:facet>
				 			<rich:column style="width:18px">
				 				<h:graphicImage url="/img/jbpm/${node[0]}.gif" />
				 			</rich:column>
				 			<rich:column>
				 				#{node[1]}
				 			</rich:column>
				 			<rich:column style="width:15px">
				 				<h:graphicImage 
				 					url="/img/jbpm/#{processBuilder.newNodeType == node[0] ? 'checked' : 'unchecked'}.gif">
				 					<a:support event="onclick"
				 						ajaxSingle="true"
				 						reRender="nodeTypes,inTransition"
				 						action="#{processBuilder.setNewNodeType(node[0])}"/>
				 				</h:graphicImage>
				 			</rich:column>
				 		</rich:dataTable>

			 		<s:div style="float:left; margin-left:10px">
				 		<s:decorate template="/WEB-INF/xhtml/components/templates/edit.xhtml">
					 		<ui:define name="label">Nome:</ui:define>
					 		<h:inputText id="newNodeName"
					 					 label="Nome"
					 					 styleClass="inputText"
					 					 value="#{processBuilder.newNodeName}">
					 			<wi:ajaxSupport/>
					 		</h:inputText>
					 	</s:decorate>
					 	<s:decorate template="/WEB-INF/xhtml/components/templates/edit.xhtml">	
					 		<ui:define name="label">Inserir após:</ui:define>
					 		<h:selectOneMenu id="after"					 
											 style="min-width: 250px;"
											 value="#{processBuilder.newNodeAfter}">
								<f:selectItems value="#{processBuilder.nodesItems}"/>
								<wi:ajaxSupport/>
							</h:selectOneMenu>
					 	</s:decorate>
						<s:div  id="inTransition">
						 	<s:decorate rendered="#{processBuilder.newNodeType != 'EndState'}"
						 				template="/WEB-INF/xhtml/components/templates/edit.xhtml">	
						 		<ui:define name="label">Na transição:</ui:define>
						 		<h:selectOneMenu id="after"	
												 style="min-width: 250px;"
												 value="#{processBuilder.newNodeTransition}">
									<f:selectItems value="#{processBuilder.transitionsItems}"/>
									<wi:ajaxSupport/>
								</h:selectOneMenu>
						 	</s:decorate>	
						</s:div>
						<a:commandButton styleClass="dr-tbpnl-tb-inact" 
							value="Inserir"
							reRender="nodesDiv" 
							ajaxSingle="true"
							action="#{processBuilder.addNewNode()}" />
			 		</s:div>
		 		</rich:panel>
				
			</s:div>
		</s:div>
		</s:div>
		
		<wi:modalPanel id="transitionCondition" 
					   height="150" 
					   width="550"
					   resizeable="false"
					   labelHeader="Condição para a transição">
			<a:commandLink id="#{type}Link" 
				reRender="actionTemplate"
				onclick="idTextarea='form:nodes:conditionInputDecoration:conditionInput'"
				action="#{actionTemplateHandler.setCurrentActionTemplate(processBuilder.currentTransition.condition)}" >
				<h:graphicImage url="/img/jbpm/wizard.gif" 
					title="Assistente para expressão"
					style="position: absolute; margin-left: 80px; margin-top: 3px;"/>
		        <rich:componentControl for="actionTemplatePanel" 
		        	operation="show" 
		        	event="oncomplete"/>
			</a:commandLink>
			<div style="padding: 10px">
				<wi:inputTextarea id="conditionInput" 
					value="#{processBuilder.currentTransition.condition}" 
					widthDiv="500px"
					style="width:100%"
					label="Expressão:">
					<wi:ajaxSupport reRender="transitiontoTable,transitionfromTable"/>
				</wi:inputTextarea>
				<a:commandButton type="button"
					style="margin-left: 200px; margin-top: 10px"
					onclick="Richfaces.hideTopModalPanel()"
					styleClass="buttons dr-tbpnl-tb-inact" 
					value="OK" />
			</div>		   
		</wi:modalPanel>
				
	</f:subview>

</ui:composition>