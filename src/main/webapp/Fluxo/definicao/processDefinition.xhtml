<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:a="http://richfaces.org/a4j"
  xmlns:c="http://java.sun.com/jsp/jstl/core"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:rich="http://richfaces.org/rich"
  xmlns:s="http://jboss.org/schema/seam/taglib"
  xmlns:wi="http://www.itx.com.br/jsf"
  xmlns:p="http://primefaces.org/ui"
  xmlns:infox="http://www.infox.com.br/jsf"
  template="/WEB-INF/xhtml/templates/minimal.xhtml">
 
  <ui:define name="title">#{infoxMessages['fluxo.titlePage']}: #{empty processBuilder.instance ? '' : processBuilder.instance.name}</ui:define>
  <ui:define name="head">
  	<c:set property="idFluxo" target="#{historicoProcessDefinitionList}" value="#{fluxoController.fluxo.idFluxo}" />
	<f:metadata>
		<f:event listener="#{processBuilder.load()}" type="preRenderView" />
	</f:metadata>
    <h:outputScript
      name="jbpmGraph.js"
      library="js" />
    <h:outputScript
      name="underscore.js"
      library="js" />
    <h:outputStylesheet name="diagram-js.css" library="modelador/css" />
	<link type="text/css" href="#{pathResolver.contextPath}/resources/modelador/vendor/bpmn-font/css/bpmn.css" rel="stylesheet"></link>
	<h:outputScript name="bundle.js" library="modelador" />
  </ui:define>
  <ui:define name="body">
    <!-- rich:tree para carregar javascript da tree para o nó de email. Não retirar, ver ticket #70361  -->
  	<rich:tree />
    <ui:param
      name="def"
      value="#{processBuilder.instance}" />
      
   	 <h:form id="modeladorForm">
		<a:jsFunction name="doUpdate" execute="@this" render=":processDefinition @form :pageBodyDialogMessage" action="#{bpmnView.update}"
			oncomplete="infox.hideLoading()" actionListener="#{processBuilder.prepareUpdate}">
			<a:param name="bpmnInformation" assignTo="#{bpmnView.bpmnInformation}"/>
		</a:jsFunction>
		<a:jsFunction name="configureElement" execute="@this" render=":processDefinition :pageBodyDialogMessage" action="#{bpmnView.configureElement}">
			<a:param name="elementKey" assignTo="#{bpmnView.elementKey}" />
		</a:jsFunction>
     	
     	<h:inputHidden id="bpmn" value="#{bpmnView.fluxo.bpmn}" />
		
		<script>
			function updateBpmn() {
				doUpdate(JSON.stringify(modeler.getBpmnInformation()));
			}
			
			function initModelador(container) {
				var bpmn;
				if (!window.modeler) {
					bpmn = document.getElementById("#{rich:clientId('bpmn')}").value;
				} else {
					bpmn = window.modeler.getBpmnInformation().bpmn;
				}
		        window.modeler = new InfoxBpmnModeler({
		        	'container': document.getElementById(container),
		        	'bpmn': bpmn,
		        	'configureElement': configureElement
		        });
			}
		</script>
	</h:form>
	
    <infox:tabPanel
      switchType="ajax"
      activeTab="#{processBuilder.tab}"
      id="processDefinition">
      <h:form>
        <infox:tabHeaders />
      </h:form>
      <infox:tab
        name="propriedadesTab"
        id="propriedadesTab"
        title="#{infoxMessages['processBuilder.properties']}"
        render="processDefinitionButtonsForm">
        <rich:panel header="#{infoxMessages['processBuilder.info']}">
          <h:form>
            <wi:inputText
              id="codFluxo"
              label="#{infoxMessages['fluxo.codFluxo']}"
              value="#{processBuilder.fluxo.codFluxo}"
              readonly="true">
              <f:validator validatorId="jsfComponentIdValidator" />
            </wi:inputText>
            <wi:inputText
              id="nome"
              label="#{infoxMessages['fluxo.fluxo']}"
              value="#{def.name}"
              readonly="true" />
            <wi:inputTextarea
              id="description"
              value="#{def.description}"
              label="#{infoxMessages['processBuilder.description']}"
              showCounter="false">
              <a:ajax
                event="change"
                execute="@this" />
            </wi:inputTextarea>
          </h:form>
        </rich:panel>
        <ui:include src="historico.xhtml" />
        <rich:panel
          styleClass="SwimlanePanel"
          header="#{infoxMessages['processBuilder.swimlanes']}">
          <ui:include src="swimlanes.xhtml" />
        </rich:panel>
        <p:outputPanel layout="block" id="modeladorAbaPropriedades" style="visibility: hidden; width: 0px; height: 0px;" />
        <script>
	        initModelador("#{rich:clientId('modeladorAbaPropriedades')}");
        </script>
      </infox:tab>
      <infox:tab
        name="nodesTab"
        id="nodesTab"
        title="#{infoxMessages['processBuilder.nodes']}"
        render="processDefinitionButtonsForm">
        <ui:include src="nodes.xhtml" />
        <p:outputPanel layout="block" id="modeladorAbaNos" style="visibility: hidden; width: 0px; height: 0px;" />
        <script>
        	initModelador("#{rich:clientId('modeladorAbaNos')}");
        </script>
      </infox:tab>
      <infox:tab
        name="modeladorTab"
        id="modeladorTab"
        title="#{infoxMessages['processBuilder.modelador']}"
        render="processDefinitionButtonsForm">
        <ui:include src="modelador.xhtml" />
      </infox:tab>
    </infox:tabPanel>
    <h:form id="processDefinitionButtonsForm">
      <h:outputScript>
        function checkIfEditorExists() {
          if (typeof infox.editor!=="undefined") {
            for(var key in infox.editor) {
              infox.editor[key].instance.fire("blur");
            }
          }
          updateBpmn();
        }
      </h:outputScript>
      <a:commandButton
        id="gravar"
        value="#{infoxMessages['processBuilder.saveBtn']}"
        styleClass="buttons #{wi:get(styleClass, '')}"
        onclick="infox.showLoading(); checkIfEditorExists();" />
      <a:commandButton
        id="new"
        action="#{processBuilder.clearDefinition}"
        value="#{infoxMessages['processBuilder.newBtn']}"
        render=":processDefinition, @form"
        onclick="return confirm('#{infoxMessages['processBuilder.confirmNew']}');"
        onbeforedomupdate="delete window.modeler;"
        styleClass="buttons #{wi:get(styleClass, '')}" />
    </h:form>
    <s:div id="actionTemplate">
      <wi:modalPanel
        id="actionTemplatePanel"
        height="550"
        width="920">
        <c:if
          test="#{!empty actionTemplate.fileName or !empty taskFitter.currentTask.currentVariable}">
          <ui:include src="/Fluxo/definicao/actions/setModeloDocumento.xhtml" />
        </c:if>
      </wi:modalPanel>
    </s:div>
    <wi:modalPanel
      id="dominioVariavelTarefaPanel"
      height="550"
      width="920"
      onbeforehide="renderDominio()">
      <ui:include src="actions/dominioVariavelTarefa.xhtml" />
    </wi:modalPanel>
    <wi:modalPanel
      id="classificacoesParaVariavelPanel"
      height="550"
      width="920">
      <ui:include src="actions/addClassificacaoDocumento.xhtml" />
    </wi:modalPanel>
    
    <rich:popupPanel id="modalVisualizarHistorico" width="950" height="650" maxHeight="600" modal="true" header="Histórico">
		<f:facet name="controls">
		    <h:graphicImage styleClass="mp-close"
		        value="#{layoutController.getResourceUrlByPath('/imagens/closeMP.gif')}"
		        onclick="#{rich:component('modalVisualizarHistorico')}.hide();" />
		</f:facet>
		<ui:include src="visualizarHistorico.xhtml" />
	</rich:popupPanel>
  </ui:define>
</ui:composition>
