<?xml version="1.0" encoding="UTF-8"?>

<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:wi="http://www.itx.com.br/jsf"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:a="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:infox="http://www.infox.com.br/jsf"
	xmlns:s="http://jboss.org/schema/seam/taglib"
	template="/WEB-INF/xhtml/templates/core/menuTemplate.xhtml">

	<ui:define name="title">#{eppmessages['comunicacao.comunicacoes']}</ui:define>

	<ui:define name="body">
		<infox:tabPanel switchType="ajax"
			activeTab="#{expedicaoComunicacaoAction.tab}"
			id="comunicacaoTabPanel">
			<h:form>
				<infox:tabHeaders />
			</h:form>
			<infox:tab id="list" name="list" immediate="true"
				title="#{eppmessages['comunicacao.comunicacoes']}"
				action="#{expedicaoComunicacaoAction.setModeloComunicacao(null)}">
				<wi:dataTable id="comunicacoes" bean="#{expedicaoComunicacaoList}"
					values="#{expedicaoComunicacaoList.list(15)}"
					tableTitle="#{eppmessages['comunicacao.comunicacoes']}" rowId="#{row.id}"
					hideOrder="true">
					<ui:define name="toolBar">
						<wi:toolBarEdit />
					</ui:define>
					<ui:define name="headerToolBar" />

					<ui:define name="searchForm">
						<wi:searchForm formId="comunicacoesSearch" formTitle="#{eppmessages['searchForm.title']}">
							<wi:inputText id="numeroProcesso" label="#{eppmessages['consultaProcesso.numeroProcesso']}"
								value="#{expedicaoComunicacaoList.numeroProcesso}"/>
							<wi:selectOneMenuEntity id="tipoComunicacao" label="#{eppmessages['comunicacao.tipoComunicacao']}"
								items="#{expedicaoComunicacaoAction.tiposComunicacao}" value="#{expedicaoComunicacaoList.tipoComunicacao}" />
							<wi:selectBooleanMenu id="expedida" label="#{eppmessages['comunicacao.expedida']}" 
								value="#{expedicaoComunicacaoList.expedida}"/>
						</wi:searchForm>
					</ui:define>

					<wi:columnOutputText id="numeroProcesso"
						columnHeader="#{eppmessages['consultaProcesso.numeroProcesso']}"
						value="#{row.processo.numeroProcesso}" />
					<wi:columnOutputText id="tipoComunicacao"
						columnHeader="#{eppmessages['comunicacao.tipoComunicacao']}"
						value="#{row.tipoComunicacao.descricao}" />
					<wi:columnOutputText id="classificacao"
						columnHeader="#{eppmessages['processoDocumento.classificacaoDocumento']}"
						value="#{row.classificacaoComunicacao.descricao}" />
					<wi:columnBoolean id="expedida" columnHeader="#{eppmessages['comunicacao.expedida']}"
						value="#{expedicaoComunicacaoAction.isExpedida(row)}" />
				</wi:dataTable>
			</infox:tab>
			<infox:tab id="form" name="form" immediate="true" title="#{eppmessages['comunicacao.expedicao']}"
				rendered="#{not empty expedicaoComunicacaoAction.modeloComunicacao}">
				<wi:dataTable id="destinatarios"
					bean="#{destinatarioModeloComunicacaoList}"
					values="#{destinatarioModeloComunicacaoList.list(15)}"
					tableTitle="#{eppmessages['comunicacao.destinatarios']}" rowId="#{row.id}" showSearchForm="false"
					hideOrder="true">
					<ui:define name="toolBar">
						<h:form>
							<a:commandLink
								action="#{expedicaoComunicacaoAction.setDestinatario(row)}"
								render="comunicacaoForm" execute="@this"
								rendered="#{not empty expedicaoComunicacaoAction.comunicacao}">
								<h:graphicImage url="#{wiSkin.imageFolder}/expedir_comunicacao.png"
									title="#{eppmessages['button.selecionar']}" />
							</a:commandLink>
							<h:commandLink
								action="#{expedicaoComunicacaoAction.downloadComunicacao(row)}"
								rendered="#{row.expedido}">
								<h:graphicImage url="#{wiSkin.imageFolder}/reopen.png"
									title="#{eppmessages['comunicacao.imprimirComunicacao']}" />
							</h:commandLink>
						</h:form>
					</ui:define>
					<ui:define name="headerToolBar" />

					<wi:columnOutputText id="nome" columnHeader="#{eppmessages['comunicacao.destinatario']}"
						value="#{row.nome}" />
					<wi:columnOutputText id="meioExpedicao"
						columnHeader="#{eppmessages['comunicacao.meioExpedicao']}"
						value="#{row.meioExpedicao.label}" />
					<wi:columnOutputText id="prazo" columnHeader="#{eppmessages['comunicacao.prazoAtendimento']}"
						value="#{row.prazo}" />
				</wi:dataTable>
				<h:form id="comunicacaoForm">
					<rich:collapsiblePanel
						header="#{eppmessages['comunicacao.comunicacao']} #{not empty expedicaoComunicacaoAction.destinatario.nome ? '- '.concat(expedicaoComunicacaoAction.destinatario.nome) : ''}"
						expanded="false" id="painelComunicacao" switchType="client"
						rendered="#{not empty expedicaoComunicacaoAction.comunicacao}">
						<wi:editor id="comunicacao" readonly="true"
							value="#{expedicaoComunicacaoAction.comunicacao}" />
					</rich:collapsiblePanel>
					<h:commandButton id="visualizarComunicacao" action="#{expedicaoComunicacaoAction.downloadComunicacao(null)}" 
						value="#{eppmessages['comunicacao.visualizarComunicacao']}" styleClass="buttons" 
						rendered="#{empty expedicaoComunicacaoAction.comunicacao and not expedicaoComunicacaoAction.isExpedida(expedicaoComunicacaoAction.modeloComunicacao)}"/>
					<wi:commandButton id="expedir" action="expedicaoComunicacaoAction.expedirComunicacao()" 
						rendered="#{expedicaoComunicacaoAction.documentoComunicacaoAssinado}"
						value="#{eppmessages['comunicacao.expedirComunicacoes']}"
						reRender="comunicacaoForm, pageBodyDialogMessage, destinatarios"/>
					<a:jsFunction name="assinar"
								action="#{expedicaoComunicacaoAction.expedirComunicacao()}"
								execute="@form"
								render="comunicacaoForm, pageBodyDialogMessage, destinatarios"
								oncomplete="infox.hideLoading();" />
					<wi:certificadoDigital id="appletAssinatura"
							urlDownloadFile="#{pathResolver.urlProject}/downloadCaList.seam"
							formId="#{rich:clientId('comunicacaoForm')}"
							certificationChainField="#{expedicaoComunicacaoAction.certChain}"
							signatureField="#{expedicaoComunicacaoAction.signature}"
							signableData="#{expedicaoComunicacaoAction.md5Comunicacao}" useBase64Function="true"
							functionPreSign="infox.showLoading();"
							functionPosSign="assinar();" debug="false" loginMode="false"
							useProviderDll="false"
							rendered="#{expedicaoComunicacaoAction.podeRenderizarApplet()}"
							signButtonCaption="#{eppmessages['comunicacao.expedirComunicacao']}">
					</wi:certificadoDigital>
				</h:form>
			</infox:tab>
		</infox:tabPanel>
	</ui:define>

</ui:composition>
