<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:wi="http://www.itx.com.br/jsf"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:a="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:infox="http://www.infox.com.br/jsf"
	xmlns:s="http://jboss.org/schema/seam/taglib"
	template="/WEB-INF/xhtml/templates/core/menuTemplate.xhtml">

	<ui:define name="title">#{infoxMessages['comunicacao.comunicacoes']}</ui:define>

	<ui:define name="body">
		<infox:tabPanel switchType="ajax"
			activeTab="#{expedicaoComunicacaoAction.tab}"
			id="comunicacaoTabPanel">
			<h:form>
				<infox:tabHeaders />
			</h:form>
			<infox:tab id="list" name="list" immediate="true"
				title="#{infoxMessages['comunicacao.comunicacoes']}"
				action="#{expedicaoComunicacaoAction.setModeloComunicacao(null)}">
				<wi:dataTable id="comunicacoes" bean="#{expedicaoComunicacaoList}"
					values="#{expedicaoComunicacaoList.list(15)}"
					tableTitle="#{infoxMessages['comunicacao.comunicacoes']}" rowId="#{row.id}"
					hideOrder="true">
					<ui:define name="toolBar">
						<wi:toolBarEdit />
					</ui:define>
					<ui:define name="headerToolBar" />

					<ui:define name="searchForm">
						<wi:searchForm formId="comunicacoesSearch" formTitle="#{infoxMessages['searchForm.title']}">
							<wi:inputText id="numeroProcesso" label="#{infoxMessages['consultaProcesso.numeroProcesso']}"
								value="#{expedicaoComunicacaoList.numeroProcesso}"/>
							<wi:selectOneMenuEntity id="tipoComunicacao" label="#{infoxMessages['comunicacao.tipoComunicacao']}"
								items="#{expedicaoComunicacaoAction.tiposComunicacao}" value="#{expedicaoComunicacaoList.tipoComunicacao}" />
							<wi:selectBooleanCheckbox id="expedida" label="#{infoxMessages['comunicacao.expedida']}" 
                                value="#{expedicaoComunicacaoList.expedida}"/>
						</wi:searchForm>
					</ui:define>

					<wi:columnOutputText id="numeroProcesso"
						columnHeader="#{infoxMessages['consultaProcesso.numeroProcesso']}"
						value="#{row.processo.numeroProcessoRoot}" />
					<wi:columnOutputText id="tipoComunicacao"
						columnHeader="#{infoxMessages['comunicacao.tipoComunicacao']}"
						value="#{row.tipoComunicacao.descricao}" />
					<wi:columnOutputText id="classificacao"
						columnHeader="#{infoxMessages['processoDocumento.classificacaoDocumento']}"
						value="#{row.classificacaoComunicacao.descricao}" />
					<wi:columnBoolean id="expedida" columnHeader="#{infoxMessages['comunicacao.expedida']}"
						value="#{expedicaoComunicacaoAction.isExpedida(row)}" />
				</wi:dataTable>
			</infox:tab>
			<infox:tab id="form" name="form" immediate="true" title="#{infoxMessages['comunicacao.expedicao']}"
				rendered="#{not empty expedicaoComunicacaoAction.modeloComunicacao}">
				<wi:dataTable id="destinatarios"
					bean="#{destinatarioModeloComunicacaoList}"
					values="#{destinatarioModeloComunicacaoList.list(15)}"
					tableTitle="#{infoxMessages['comunicacao.destinatarios']}" rowId="#{row.id}" showSearchForm="false"
					hideOrder="true" showToolbarColumn="#{!expedicaoComunicacaoAction.modeloComunicacao.documentoBinario}">
					<ui:define name="toolBar">
						<h:form>
							<a:commandLink
								action="#{expedicaoComunicacaoAction.setDestinatario(row)}"
								render="comunicacaoForm" execute="@this"
								rendered="#{not row.expedido}">
								<h:graphicImage url="#{layoutController.getResourceUrlByPath('/imagens/expedir_comunicacao.png')}"
									title="#{infoxMessages['button.selecionar']}" />
							</a:commandLink>
							
							<a:commandLink action="#{jsfUtil.applyLastPhaseFlashAction}" 
								oncomplete="infox.openPopUp('download', '#{pathResolver.contextPath}/Processo/baixarComunicacao.seam','1024');"
								rendered="#{row.expedido}" render="@this" execute="@this">
								<h:graphicImage url="#{layoutController.getResourceUrlByPath('/imagens/reopen.png')}" title="#{infoxMessages['comunicacao.imprimirComunicacao']}" />
								<f:setPropertyActionListener value="#{row.id}" target="#{flash.idDestinatario}" />
							</a:commandLink>
						</h:form>
					</ui:define>
					<ui:define name="headerToolBar" />

					<wi:columnOutputText id="nome" columnHeader="#{infoxMessages['comunicacao.destinatario']}"
						value="#{row.nome}" />
					<wi:columnOutputText id="meioExpedicao"
						columnHeader="#{infoxMessages['comunicacao.meioExpedicao']}"
						value="#{row.meioExpedicao.descricao}" />
					<wi:columnOutputText id="prazo" columnHeader="#{infoxMessages['comunicacao.prazoAtendimento']}"
						value="#{row.prazo}" />
				</wi:dataTable>
				<h:form id="comunicacaoForm">
					<a:commandButton id="visualizarComunicacaoIndividual"
									action="#{jsfUtil.applyLastPhaseFlashAction}" 
									value="#{infoxMessages['comunicacao.visualizarComunicacao']}" 
									styleClass="buttons" render="@this" execute="@this"
									rendered="#{not empty expedicaoComunicacaoAction.destinatario}"
									oncomplete="infox.openPopUp('download', '#{pathResolver.contextPath}/Processo/baixarComunicacao.seam','1024');" >
						<f:setPropertyActionListener value="#{expedicaoComunicacaoAction.destinatario.id}" target="#{flash.idDestinatario}" />
					</a:commandButton>
					<a:commandButton id="visualizarComunicacaoGeral"
									action="#{jsfUtil.applyLastPhaseFlashAction}"
									value="#{infoxMessages['comunicacao.visualizarComunicacao']}" 
									styleClass="buttons" render="@this" execute="@this"
									rendered="#{expedicaoComunicacaoAction.modeloComunicacao.documentoBinario}"
									oncomplete="infox.openPopUp('download', '#{pathResolver.contextPath}/Processo/baixarComunicacao.seam','1024');" >
						<f:setPropertyActionListener value="#{expedicaoComunicacaoAction.modeloComunicacao.id}" target="#{flash.idModelo}" />
						<f:setPropertyActionListener value="#{expedicaoComunicacaoAction.modeloComunicacao.destinatarios.get(0).id}" target="#{flash.idDestinatario}" />
					</a:commandButton>
					
					<a:jsFunction name="assinar"
								action="#{expedicaoComunicacaoAction.expedirComunicacao()}"
								execute="@form"
								render="comunicacaoForm, pageBodyDialogMessage, destinatarios"
								oncomplete="infox.hideLoading();" />
					<wi:certificadoDigital id="appletAssinatura"
                            tokenField="#{expedicaoComunicacaoAction.token}"
							signableData="#{expedicaoComunicacaoAction.md5Comunicacao}"
							functionPreSign="infox.showLoading();"
							functionPosSign="assinar();"
							rendered="#{expedicaoComunicacaoAction.podeRenderizarApplet() and not expedicaoComunicacaoAction.destinatario.expedido}"
							signButtonCaption="#{infoxMessages['comunicacao.expedirComunicacao']}"/>
							
					<a:commandButton id="btnExpedirComunicacaoAssinada" execute="@form" styleClass="buttons"
						value="${infoxMessages['comunicacao.expedirComunicacao']}"
						rendered="#{expedicaoComunicacaoAction.comunicacaoSuficientementeAssinada and not expedicaoComunicacaoAction.destinatario.expedido}"
						action="#{expedicaoComunicacaoAction.expedirComunicacao()}"
						onclick="infox.showLoading();"
						render="comunicacaoForm, pageBodyDialogMessage, destinatarios"
						oncomplete="infox.hideLoading();"/>
						
					<a:commandButton id="reabrirComunicacao" 
						render="comunicacaoTabPanel :pageBodyDialogMessage" execute="@this"
						value="#{infoxMessages['comunicacao.devolverEdicao']}" 
						styleClass="buttons"
						rendered="#{expedicaoComunicacaoAction.modeloComunicacao.finalizada and not expedicaoComunicacaoAction.isExpedida(expedicaoComunicacaoAction.modeloComunicacao)}"
						action="#{expedicaoComunicacaoAction.reabrirComunicacao()}" 
						onclick="infox.showLoading();"
						oncomplete="infox.hideLoading();"/>
						
				</h:form>
			</infox:tab>
		</infox:tabPanel>
	</ui:define>

</ui:composition>
