<?xml version="1.0" encoding="UTF-8"?>

<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:wi="http://www.itx.com.br/jsf"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:a="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:infox="http://www.infox.com.br/jsf"
    xmlns:s="http://jboss.org/schema/seam/taglib"
    template="/WEB-INF/xhtml/templates/core/menuTemplate.xhtml">

    <ui:define name="title">#{eppmessages['expedicaoComunicacao.titlePage']}</ui:define>
    
    <ui:define name="body">
    	<infox:tabPanel switchType="ajax" activeTab="#{expedicaoComunicacaoAction.tab}" id="comunicacaoTabPanel">
    		<h:form>
    			<infox:tabHeaders />
   			</h:form>
   			<infox:tab id="list" name="list" immediate="true" title="Comunicações não expedidas"
   				action="#{expedicaoComunicacaoAction.setModeloComunicacao(null)}">
   				<wi:dataTable id="comunicacoes" bean="#{expedicaoComunicacaoList}" values="#{expedicaoComunicacaoList.list(15)}"
   					tableTitle="Comunicações não expedidas" rowId="#{row.id}" showSearchForm="false" hideOrder="true">
   					<ui:define name="toolBar">
   						<wi:toolBarEdit />
   					</ui:define>
   					<ui:define name="headerToolBar" />
   					
   					<wi:columnOutputText id="numeroProcesso" columnHeader="Número do Processo" value="#{row.processo.numeroProcesso}" />
   					<wi:columnOutputText id="tipoComunicacao" columnHeader="Tipo de Comunicação" value="#{row.tipoComunicacao.descricao}" />
   					<wi:columnOutputText id="classificacao" columnHeader="Classificação de Documento" value="#{row.classificacaoComunicacao.descricao}" />
   				</wi:dataTable>
   			</infox:tab>
   			<infox:tab id="form" name="form" immediate="true" title="Expedição" rendered="#{not empty expedicaoComunicacaoAction.modeloComunicacao}">
   				<wi:dataTable id="destinatarios" bean="#{destinatarioModeloComunicacaoList}" values="#{destinatarioModeloComunicacaoList.list(15)}"
   					tableTitle="Destinatários" rowId="#{row.id}" showSearchForm="false" hideOrder="true">
   					<ui:define name="toolBar">
   						<h:form>
   							<a:commandLink action="#{expedicaoComunicacaoAction.setDestinatario(row)}" render="comunicacaoForm">
   								<h:graphicImage url="#{wiSkin.imageFolder}/view.png" title="#{eppmessages['button.selecionar']}" />
   							</a:commandLink>
   						</h:form>
   					</ui:define>
   					<ui:define name="headerToolBar" />
   					
   					<wi:columnOutputText id="nome" columnHeader="Nome" value="#{expedicaoComunicacaoAction.getNomeDestinatario(row)}" />
   					<wi:columnOutputText id="meioExpedicao" columnHeader="Meio de Expedição" value="#{row.meioExpedicao.label}" />
   					<wi:columnOutputText id="prazo" columnHeader="Prazo" value="#{row.prazo}" />
   					<wi:columnOutputText id="expedida" columnHeader="Expedida Por" value="-" />
   				</wi:dataTable>
   				<h:form id="comunicacaoForm">
   					<rich:collapsiblePanel header="Comunicação #{not empty expedicaoComunicacaoAction.nomeDestinatario ? '- '.concat(expedicaoComunicacaoAction.nomeDestinatario) : ''}" 
   						expanded="false" id="painelComunicacao" switchType="client">
	   					<wi:editor id="comunicacao" readonly="true" value="#{expedicaoComunicacaoAction.comunicacao}" />
	   					<s:div id="assinatura_pers">
				              <a:jsFunction name="assinar" action="#{expedicaoComunicacaoAction.expedirComunicacao()}"
				              	execute="@this certChain signature" render="comunicacaoForm, pageBodyDialogMessage, destinatarios"
				                oncomplete="infox.hideLoading();" />
				              
				              <h:inputHidden id="certChain" value="#{validaDocumentoAction.certChain}" />
				              <h:inputHidden id="signature" value="#{validaDocumentoAction.signature}" />
				              <wi:appletAssinatura id="appletAssinatura" urlDownloadFile="#{pathResolver.urlProject}/downloadCaList.seam"
				                formId="#{rich:clientId('comunicacaoForm')}" certificationChainField="#{rich:clientId('certChain')}"
				                signatureField="#{rich:clientId('signature')}" getDataFunction="documento.getData()"
				                useBase64Function="'true'" functionPreSign="infox.showLoading();"
				                functionPosSign="assinar();" debug="false" loginMode="false" useProviderDll="false"
				                rendered="#{not empty expedicaoComunicacaoAction.destinatario and not expedicaoComunicacaoAction.destinatario.expedido and expedicaoComunicacaoAction.podeRenderizarApplet()}"
				                signButtonCaption="Expedir Comunicação">
				              </wi:appletAssinatura>
				              
				              <h:inputHidden id="dadosAssinaveis" value="#{expedicaoComunicacaoAction.comunicacao}" />
				              
				              <h:outputScript>
				                var documento={
				                  getData:function getData() {
				                    return #{rich:jQuery('dadosAssinaveis')}.val();
				                  }
				                };
				              </h:outputScript>
			            </s:div>
   					</rich:collapsiblePanel>
   				</h:form>
   			</infox:tab>
    	</infox:tabPanel>
    </ui:define>
    
</ui:composition>
