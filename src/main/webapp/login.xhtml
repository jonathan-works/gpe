<?xml version="1.0" encoding="ISO-8859-1"?>

<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.org/schema/seam/taglib"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a="http://richfaces.org/a4j"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:wi="http://www.itx.com.br/jsf"
	template="/WEB-INF/xhtml/templates/core/baseTemplate.xhtml">
	
	<ui:define name="baseHead">
		
	</ui:define>

	<ui:define name="baseBody">
		<s:div id="pageBody" styleClass="pageBody" style="width:100%; height:100%">
			<ui:param name="useCertLogin"  value="#{(loginComCertificado or producao) and false}" />
			<div id="seletorSkinLogin" class="seletorSkinsLogin" >
				<ui:include src="/WEB-INF/xhtml/templates/seletorSkins.xhtml">
					<ui:param name="id" value="login" />
				    <ui:param name="mostrarMenu" value="true" />
				</ui:include>
			</div>
			<h:form id="login">
				<div id="corpoInfeior" class="corpoInferior" />
				<div id="corpoSuperior" class="corpoSuperior" />
				<div id="blocoCentralLogin" class="blocoCentralLogin" >
					<div id="logo" class="logo">
					    <h:graphicImage style="width: 373px; height: 141px;"
										title="Logo"
										url="#{a4jSkin.imgLogoLogin}"/>
				    </div>
					<div id="login" class="login">
						<div id="bg_login" class="bg_login">
							<h:outputLabel for="username"
										   rendered="#{not useCertLogin}"
										   class="label_login">
								#{messages['login.nomeUsuario']}
							</h:outputLabel>
							<h:inputText id="username"
										 value="#{credentials.username}"
										 class="input_login"
										 rendered="#{not useCertLogin}"/><br />
							<h:outputLabel for="password"
									       rendered="#{not useCertLogin}"
									       class="label_login">
								#{messages['login.senha']}
							</h:outputLabel>
							<h:inputSecret id="password" 
										   value="#{credentials.password}"
										   rendered="#{not useCertLogin}"
										   class="input_login" />
						</div>
						<c:if test="#{not useCertLogin}">
							<div id="novaSenha" 
								 style="display: none;"
								 class="newPasswd" >
								<h:outputLabel for="newPassword1"
											   rendered="#{not useCertLogin}"
											   class="label_login">
									#{messages['login.novaSenha']}
								</h:outputLabel>
								<h:inputSecret id="newPassword1"
											   class="input_login"
											   value="#{authenticator.newPassword1}" /><br/>
								<h:outputLabel for="newPassword2"
											   rendered="#{not useCertLogin}"
											   class="label_login">
									#{messages['login.confirmacaoNovaSenha']}
								</h:outputLabel>	
								<h:inputSecret id="newPassword2"
											   class="input_login"
											   value="#{authenticator.newPassword2}"/>							
							</div>
						</c:if>
					</div>
					<div id="logo_baixo" class="logo_inferior">
				    	<h:graphicImage style="width: 373px; height: 84px;"
										title="Sombra Logo"
										url="#{a4jSkin.imgLogoLoginSombra}"/>
				    </div>
					<div id="login_inferior" class="login_inferior">
						<div id="bg_login_inferior" class="bg_login_inferior">
								<c:if test="#{not useCertLogin}">
									<h:commandButton
										id="btnEntrar"
										value="#{messages['login.entrarBtn']}" 
										class="input_button"
										action="#{authenticator.login()}"/> 
									
									<script>
										function mudar(){
											if ($("#novaSenha").is(':hidden')){
												$("#novaSenha").show();
												$("#btnTrocar").val("#{messages['login.naoTrocarSenhaBtn']}");
											}
											else{
												$("#novaSenha").hide();
												$("#btnTrocar").val("#{messages['login.trocarSenhaBtn']}");
												$("#login\\:newPassword1").val('');
												$("#login\\:newPassword2").val('');
											}
											return false;
										}
							        </script>
							
							        <input class="input_button" id="btnTrocar"
										type="button" value="#{messages['login.trocarSenhaBtn']}" style="width: 110px"
										onclick="mudar()" /> 
									
									<input class="input_button"
										id="btnTrocarSenha" type="button" value="#{messages['login.requisitarSenhaBtn']}"
										style="width: 170px" 
										onclick="#{rich:component('panelTeste')}.show();" />
								</c:if>
								
								<c:if test="#{useCertLogin}">
									<wi:appletAssinatura 
										width="80"
										id="certificacao" 
										formId="login"
										signButtonCaption="Entrar"
										certificationChainField="login:certChain"
										signatureField="login:signature"
										functionPreSign="#{rich:component('mp_formValidar')}.show();"	
										functionPosSign="#{rich:component('mp_formValidar')}.hide();"
										functionPosSignOk="checkValidacao();"	
										loginMode="true" />
								</c:if>
					        </div>
					  </div>
				</div>
				
				<h:inputHidden id="signature" 
					rendered="#{useCertLogin}"
					value="#{authenticator.assinatura}" />
					
				<h:inputHidden id="certChain" 
					rendered="#{useCertLogin}"
					value="#{authenticator.certChain}" />				
						
				<h:inputHidden id="certChainStringLog" 
					rendered="#{useCertLogin}"
					value="#{authenticator.certChainStringLog}" />	
										
		        <a:jsFunction 
		        	rendered="#{useCertLogin}"
		        	name="submitForm" 
		        	status="status"
		        	action="#{authenticator.authenticateSC()}" 
		        	oncomplete="mostrarInconsistencia();"
		        	reRender="pagina" />
		        	
		        <a:jsFunction 
		        	rendered="#{useCertLogin}"
		        	name="logCertChain" 
		        	action="#{authenticator.executeLogCertificadoInvalido()}" 
		        	status="status"
		        	reRender="pagina" />	        	
		
				<script>
				  function checkValidacao() {
					  submitForm();
				  }	
				</script>
				
			</h:form>
			
			<rich:popupPanel id="panelTeste" width="370" height="320">
				<f:facet name="header">#{messages['login.requisitarSenha']}</f:facet>			
				<f:facet name="controls">
					<h:panelGroup>
						<h:graphicImage value="/img/closeMP.gif"
							onclick="#{rich:component('panelTeste')}.hide()"/>
					</h:panelGroup>
				</f:facet>			
				<h:form id="gerarSenha" rendered="#{not useCertLogin}">
					<div id="receberNovaSenha" class="reqSenha">
						<div class="bg_login">
							<h:outputLabel for="login"
										   class="label_login">
								#{messages['login.nomeUsuario']}
							</h:outputLabel>
							<h:inputText id="login"
										 class="input_login"
										 value="#{usuarioHome.login}" /><br/>
							
							<h:outputLabel for="email"
										   class="label_login">
								#{messages['login.emailUsuario']}
							</h:outputLabel>
							<h:inputText id="email"
										 class="input_login"
										 value="#{usuarioHome.email}"/>
						</div>			
					</div>
					<div class="reqSenhaInferior">
						<div class="bg_login_inferior">
							<h:commandButton id="confirma"
											 class="input_button"
											 value="#{messages['login.confirmaTrocaSenhaBtn']}"
											 action="#{usuarioHome.requisitarNovaSenha()}" /> 
						
							<input class="input_button"
								   id="btnTrocarSenha2" 
							       type="button"
							       value="#{messages['login.cancelaTrocaSenhaBtn']}" 
								   onclick="#{rich:component('panelTeste')}.hide()" />
						</div>
					</div>
				</h:form>
			</rich:popupPanel>
			
			<rich:popupPanel id="mp_formValidar" height="100" width="250"
							 rendered="#{useCertLogin}" resizeable="false">
				<f:facet name="header">
					<h:outputText value="Aguarde a incialização do SmartCard." />
				</f:facet>
				<div style="text-align: center; padding-top: 30px">
					<h:graphicImage url="/img/ajax-loader.gif" />
				</div>
			</rich:popupPanel>					
					
			<br /> <rich:messages></rich:messages>
		</s:div>
	</ui:define>
	
</ui:composition>